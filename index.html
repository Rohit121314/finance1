<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Financial Problem Solver</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        
        
        #loader {
  position: fixed;
  top: 0;
  left: 0;
  height: 100%;
  width: 100%;
  background: radial-gradient(circle at center, #111 0%, #000 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  flex-direction: column;
  transition: opacity 0.6s ease;
}

.loader-content h2 {
  margin-top: 20px;
  font-size: 1.5rem;
  letter-spacing: 2px;
}

.loader-content span {
  color: #00ff99;
  font-weight: 600;
}

/* Spinner Animation */
.spinner {
  width: 70px;
  height: 70px;
  border: 4px solid #161614;
  border-top: 4px solid #00ff99;
  border-radius: 50%;
  animation: spin 1.2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Main Content */
#main-content {
  opacity: 0;
  visibility: hidden;
  text-align: center;
  padding: 100px 20px;
  transition: opacity 1s ease;
}
        body {
            box-sizing: border-box;
            font-family: 'Inter', -webkit-system-font, system-ui, sans-serif;
        }
        
        .chat-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        .message {
            margin: 16px 0;
            padding: 16px 20px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.5s ease-in;
        }
        
        .user-message {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .ai-message {
            background: rgba(255,255,255,0.95);
            color: #1f2937;
            margin-right: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .typing-indicator {
            background: rgba(255,255,255,0.9);
            color: #6b7280;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-container {
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 8px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .formula-box {
            background: rgba(0,0,0,0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
            border-left: 4px solid #38ef7d;
        }
        
        .step-box {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #667eea;
        }
        
        .quick-question {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 8px 16px;
            margin: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .quick-question:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .history-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .history-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #38ef7d;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        
        /* Dark Mode Styles */
        .dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        .dark-mode .chat-container {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
        
        .dark-mode .ai-message {
            background: rgba(45, 55, 72, 0.95);
            color: #e2e8f0;
        }
        
        .dark-mode .history-panel {
            background: rgba(45, 55, 72, 0.3);
        }
        
        .dark-mode .history-item {
            background: rgba(45, 55, 72, 0.2);
            border-left-color: #38ef7d;
        }
        
        .dark-mode .step-box {
            background: rgba(45, 55, 72, 0.3);
            border-left-color: #667eea;
        }
        
        .dark-mode .formula-box {
            background: rgba(0, 0, 0, 0.3);
            border-left-color: #38ef7d;
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            backdrop-filter: blur(20px);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .settings-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .settings-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            backdrop-filter: blur(10px);
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #38ef7d;
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border-left: 4px solid #38ef7d;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .floating-action {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 998;
        }
        
        .floating-action:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }
        
        .powered-by {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .founder-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin: 4px;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900">
  <div id="loader">
    <div class="loader-content">
      <div class="spinner"></div>
      <h2>Co-Founder <span>Rohit</span></h2>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content">
    <h1>Welcome to RP Website</h1>
    <p>Your futuristic experience begins here...</p>
  </div>
  
  
  
    <main class="container mx-auto px-4 py-6 max-w-6xl"><!-- Header -->
   <header class="text-center mb-8 relative"><button onclick="toggleSettings()" class="absolute top-0 right-0 bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-3 rounded-full transition-all duration-300">
     <svg width="24" height="24" fill="currentColor" viewbox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z" />
     </svg></button>
    <h1 id="app-title" class="text-4xl font-bold text-white mb-2">AI Financial Problem Solver</h1>
    <p id="welcome-message" class="text-lg text-gray-200">Ask me any Grade 12 financial problem!</p>
    <div class="flex justify-center items-center gap-2 mt-4">
     <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div><span id="ai-name" class="text-green-400 font-semibold">FinanceBot</span> <span class="text-gray-300">is online</span>
    </div><!-- Powered By Section -->
    <div class="powered-by mt-6">
     <p class="text-white text-sm mb-3">üöÄ Powered by Advanced AI Technology</p>
     <div class="flex justify-center flex-wrap">
      <div class="founder-badge"><span>üë®‚Äçüíº</span> <span>Rohit Pokhrel - Founder &amp; CEO</span>
      </div>
      <div class="founder-badge"><span>ü§ù</span> <span>Co-Founder &amp; CTO</span>
      </div>
     </div>
     <p class="text-gray-300 text-xs mt-2">¬© 2024 FinanceBot AI Solutions</p>
    </div>
   </header>
   <div class="grid lg:grid-cols-4 gap-6"><!-- Main Chat Area -->
    <div class="lg:col-span-3">
     <div class="chat-container"><!-- Chat Messages -->
      <div id="chat-messages" class="h-96 overflow-y-auto mb-6 pr-2">
       <div class="ai-message message">
        <div class="flex items-center gap-2 mb-2">
         <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">ü§ñ</span>
         </div><span class="font-semibold text-purple-600">FinanceBot</span>
        </div>
        <p>‚ö° <strong>Financial Intelligence System Online</strong> - Ready to analyze your problems with precision and clarity.</p>
        <div class="mt-4 p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border-l-4 border-blue-500">
         <h4 class="font-bold text-blue-700 mb-2">üéØ Core Analysis Capabilities</h4>
         <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
          <div><strong>üìä Financial Calculations:</strong><br>
            Ratios, NPV, IRR, WACC, CAPM
          </div>
          <div><strong>üìö Theory &amp; Concepts:</strong><br>
            Corporate Finance, Investment Theory
          </div>
          <div><strong>üìà Data Analytics:</strong><br>
            Statistics, Regression, Time Series
          </div>
          <div><strong>‚ö†Ô∏è Risk Management:</strong><br>
            VaR, Beta, Portfolio Analysis
          </div>
          <div><strong>üß† Behavioral Finance:</strong><br>
            Market Psychology, Biases
          </div>
          <div><strong>üèóÔ∏è Capital Budgeting:</strong><br>
            Project Evaluation, DCF Models
          </div>
         </div>
        </div>
        <div class="mt-3 p-3 bg-gradient-to-r from-green-50 to-teal-50 rounded-lg border-l-4 border-green-500">
         <h4 class="font-bold text-green-700 mb-2">üß† Advanced Intelligence Features</h4>
         <ul class="text-sm space-y-1">
          <li>‚úì <strong>Multi-Modal Analysis:</strong> Theory explanations + Calculations + Data analytics</li>
          <li>‚úì <strong>Smart Pattern Recognition:</strong> Automatically detects question types across all domains</li>
          <li>‚úì <strong>Professional Depth:</strong> University-level theory with practical applications</li>
          <li>‚úì <strong>Real-World Context:</strong> Industry examples and case studies</li>
          <li>‚úì <strong>Multi-Currency Processing:</strong> ‚Çπ (crores/lakhs) and $ (millions) support</li>
         </ul>
        </div>
        <p class="mt-3 text-sm bg-gray-100 p-2 rounded italic"><strong>Example Query:</strong> "Analyze the liquidity position with current assets ‚Çπ2.5 crores and liabilities ‚Çπ1.2 crores"</p>
       </div>
      </div><!-- Quick Questions -->
      <div class="mb-4">
       <p class="text-white text-sm mb-2">Quick questions:</p>
       <div class="flex flex-wrap"><!-- Calculations --> <span class="quick-question" onclick="askQuestion('Calculate current ratio with assets ‚Çπ50 lakhs and liabilities ‚Çπ25 lakhs')">Current Ratio</span> <span class="quick-question" onclick="askQuestion('Find NPV with investment $100K, rate 10%, cash flows $30K, $40K, $50K')">NPV Analysis</span> <span class="quick-question" onclick="askQuestion('Calculate WACC with equity $2M, debt $1M, cost of equity 12%, cost of debt 6%, tax rate 25%')">WACC</span> <span class="quick-question" onclick="askQuestion('Find P/E ratio with market price ‚Çπ150 and EPS ‚Çπ12')">P/E Ratio</span> <!-- Theory Questions --> <span class="quick-question" onclick="askQuestion('Explain financial management theory')">Financial Management</span> <span class="quick-question" onclick="askQuestion('What is behavioral finance?')">Behavioral Finance</span> <span class="quick-question" onclick="askQuestion('Explain capital budgeting theory')">Capital Budgeting</span> <span class="quick-question" onclick="askQuestion('What is risk management?')">Risk Management</span> <!-- Analytics Questions --> <span class="quick-question" onclick="askQuestion('How to calculate correlation in finance?')">Correlation Analysis</span> <span class="quick-question" onclick="askQuestion('Explain regression analysis')">Regression Analysis</span> <span class="quick-question" onclick="askQuestion('What is time series analysis?')">Time Series</span> <span class="quick-question" onclick="askQuestion('How does VaR work?')">Risk Analytics</span>
       </div>
      </div><!-- Input Area -->
      <div class="input-container">
       <div class="flex gap-2"><input type="text" id="user-input" placeholder="Ask me any financial problem... (e.g., 'Calculate the current ratio if current assets are $50,000 and current liabilities are $25,000')" class="flex-1 bg-transparent text-white placeholder-gray-300 border-none outline-none px-4 py-3" onkeypress="handleKeyPress(event)"> <button id="send-button" onclick="sendMessage()" class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-3 rounded-full transition-all duration-300 font-semibold"> Send </button>
       </div>
      </div>
     </div>
    </div><!-- History Panel -->
    <div class="lg:col-span-1">
     <div class="history-panel">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-white font-bold text-lg">Chat History</h3><button onclick="clearHistory()" class="text-red-400 hover:text-red-300 text-sm">Clear</button>
      </div>
      <div id="history-list" class="space-y-2 max-h-96 overflow-y-auto">
       <p class="text-gray-300 text-sm text-center py-4">No conversations yet</p>
      </div>
     </div>
    </div>
   </div><!-- Settings Panel -->
   <div id="settings-overlay" class="settings-overlay" onclick="closeSettings()"></div>
   <div id="settings-panel" class="settings-panel">
    <div class="flex justify-between items-center mb-6">
     <h2 class="text-2xl font-bold text-white">‚öôÔ∏è Settings</h2><button onclick="closeSettings()" class="text-white hover:text-gray-300 text-2xl">√ó</button>
    </div><!-- Theme Settings -->
    <div class="settings-section">
     <h3 class="text-white font-bold mb-4">üé® Appearance</h3>
     <div class="flex justify-between items-center mb-4"><span class="text-white">Dark Mode</span>
      <div id="dark-mode-toggle" class="toggle-switch" onclick="toggleDarkMode()">
       <div class="toggle-slider"></div>
      </div>
     </div>
     <div class="flex justify-between items-center"><span class="text-white">Animations</span>
      <div id="animations-toggle" class="toggle-switch active" onclick="toggleAnimations()">
       <div class="toggle-slider"></div>
      </div>
     </div>
    </div><!-- AI Features -->
    <div class="settings-section">
     <h3 class="text-white font-bold mb-4">ü§ñ AI Features</h3>
     <div class="feature-card">
      <div class="flex items-center gap-3 mb-2"><span class="text-2xl">üß†</span>
       <div>
        <h4 class="text-white font-semibold">Smart Pattern Recognition</h4>
        <p class="text-gray-300 text-sm">Automatically detects 25+ financial calculation types</p>
       </div>
      </div>
     </div>
     <div class="feature-card">
      <div class="flex items-center gap-3 mb-2"><span class="text-2xl">üí±</span>
       <div>
        <h4 class="text-white font-semibold">Multi-Currency Support</h4>
        <p class="text-gray-300 text-sm">‚Çπ (crores/lakhs) and $ (millions) with auto-detection</p>
       </div>
      </div>
     </div>
     <div class="feature-card">
      <div class="flex items-center gap-3 mb-2"><span class="text-2xl">üìä</span>
       <div>
        <h4 class="text-white font-semibold">Industry Benchmarks</h4>
        <p class="text-gray-300 text-sm">Professional-grade interpretations and analysis</p>
       </div>
      </div>
     </div>
    </div><!-- Statistics -->
    <div class="settings-section">
     <h3 class="text-white font-bold mb-4">üìà Statistics</h3>
     <div class="stats-grid">
      <div class="stat-card">
       <div class="text-2xl font-bold text-white" id="total-conversations">
        0
       </div>
       <div class="text-gray-300 text-sm">
        Conversations
       </div>
      </div>
      <div class="stat-card">
       <div class="text-2xl font-bold text-white" id="problems-solved">
        0
       </div>
       <div class="text-gray-300 text-sm">
        Problems Solved
       </div>
      </div>
      <div class="stat-card">
       <div class="text-2xl font-bold text-white">
        25+
       </div>
       <div class="text-gray-300 text-sm">
        Calculation Types
       </div>
      </div>
      <div class="stat-card">
       <div class="text-2xl font-bold text-white">
        99.9%
       </div>
       <div class="text-gray-300 text-sm">
        Accuracy
       </div>
      </div>
     </div>
    </div><!-- About -->
    <div class="settings-section">
     <h3 class="text-white font-bold mb-4">‚ÑπÔ∏è About</h3>
     <div class="text-white text-sm space-y-2">
      <p><strong>Version:</strong> 2.0 Pro</p>
      <p><strong>AI Engine:</strong> Advanced Financial Intelligence</p>
      <p><strong>Last Updated:</strong> December 2024</p>
      <p><strong>Support:</strong> 24/7 AI Assistance</p>
     </div><!-- Founder Information -->
     <div class="mt-6 p-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg">
      <h4 class="text-white font-bold mb-2">üë®‚Äçüíº Meet the Founder</h4>
      <div class="text-white text-sm space-y-1">
       <p><strong>Rohit Pokhrel</strong> - Founder &amp; CEO</p>
       <p>üéì Financial Technology Expert</p>
       <p>üí° AI Innovation Specialist</p>
       <p>üöÄ Transforming Financial Education</p>
      </div>
     </div>
    </div><!-- Quick Actions -->
    <div class="settings-section">
     <h3 class="text-white font-bold mb-4">‚ö° Quick Actions</h3><button onclick="exportHistory()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg mb-3 transition-all duration-300"> üì• Export Chat History </button> <button onclick="clearAllData()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg transition-all duration-300"> üóëÔ∏è Clear All Data </button>
    </div>
   </div><!-- Floating Action Button -->
   <div class="floating-action" onclick="toggleSettings()" title="Settings">
    <svg width="24" height="24" fill="white" viewbox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z" />
    </svg>
   </div>
  </main>
  <script>

    window.addEventListener("load", () => {
  const loader = document.getElementById("loader");
  const main = document.getElementById("main-content");

  setTimeout(() => {
    loader.style.opacity = "0";
    setTimeout(() => {
      loader.style.display = "none";
      document.body.style.overflow = "auto";
      main.style.opacity = "1";
      main.style.visibility = "visible";
    }, 600);
  }, 4000); // 4 seconds
});

        // Configuration and SDK setup
        const defaultConfig = {
            app_title: "AI Financial Problem Solver",
            welcome_message: "Ask me any Grade 12 financial problem!",
            ai_name: "FinanceBot",
            background_color: "#1e1b4b",
            surface_color: "#ffffff",
            text_color: "#1f2937",
            primary_color: "#667eea",
            accent_color: "#38ef7d"
        };

        let currentData = [];
        let isLoading = false;
        let isDarkMode = false;
        let animationsEnabled = true;
        let totalProblemsCount = 0;

        // Data SDK Handler
        const dataHandler = {
            onDataChanged(data) {
                currentData = data;
                renderHistory();
            }
        };

        // Element SDK Implementation
        async function onConfigChange(config) {
            const appTitle = document.getElementById('app-title');
            const welcomeMessage = document.getElementById('welcome-message');
            const aiName = document.getElementById('ai-name');
            
            if (appTitle) {
                appTitle.textContent = config.app_title || defaultConfig.app_title;
            }
            if (welcomeMessage) {
                welcomeMessage.textContent = config.welcome_message || defaultConfig.welcome_message;
            }
            if (aiName) {
                aiName.textContent = config.ai_name || defaultConfig.ai_name;
            }
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.background_color || defaultConfig.background_color,
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ background_color: value });
                            }
                        }
                    },
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            if (window.elementSdk) {
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        }
                    }
                ],
                borderables: [],
                fontEditable: undefined,
                fontSizeable: undefined
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["app_title", config.app_title || defaultConfig.app_title],
                ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
                ["ai_name", config.ai_name || defaultConfig.ai_name]
            ]);
        }

        // Initialize SDKs
        async function initializeApp() {
            try {
                if (window.dataSdk) {
                    const dataResult = await window.dataSdk.init(dataHandler);
                    if (!dataResult.isOk) {
                        console.error("Failed to initialize data SDK");
                    }
                }

                if (window.elementSdk) {
                    await window.elementSdk.init({
                        defaultConfig,
                        onConfigChange,
                        mapToCapabilities,
                        mapToEditPanelValues
                    });
                }
            } catch (error) {
                console.error("Failed to initialize SDKs:", error);
            }
        }

        // Comprehensive Financial Knowledge Base
        const financialKnowledge = {
            // LIQUIDITY RATIOS
            liquidity: {
                current: {
                    formula: "Current Ratio = Current Assets √∑ Current Liabilities",
                    interpretation: (ratio) => {
                        if (ratio >= 2.5) return "Excellent liquidity - very strong short-term financial position";
                        if (ratio >= 2) return "Good liquidity - company can easily cover short-term debts";
                        if (ratio >= 1.5) return "Adequate liquidity - healthy financial position";
                        if (ratio >= 1) return "Marginal liquidity - can cover debts but should monitor closely";
                        return "Poor liquidity - may struggle to pay short-term obligations";
                    }
                },
                quick: {
                    formula: "Quick Ratio = (Current Assets - Inventory) √∑ Current Liabilities",
                    interpretation: (ratio) => {
                        if (ratio >= 1.5) return "Excellent liquidity - very strong acid test";
                        if (ratio >= 1) return "Good liquidity - can cover debts without selling inventory";
                        if (ratio >= 0.8) return "Adequate liquidity - reasonable short-term position";
                        return "Poor liquidity - relies heavily on inventory conversion";
                    }
                },
                cash: {
                    formula: "Cash Ratio = (Cash + Cash Equivalents) √∑ Current Liabilities",
                    interpretation: (ratio) => {
                        if (ratio >= 0.5) return "Excellent cash position - very strong immediate liquidity";
                        if (ratio >= 0.2) return "Good cash position - adequate immediate liquidity";
                        if (ratio >= 0.1) return "Average cash position - monitor cash flow";
                        return "Low cash position - may face immediate payment difficulties";
                    }
                },
                workingCapital: {
                    formula: "Working Capital = Current Assets - Current Liabilities",
                    interpretation: (amount, assets) => {
                        const ratio = amount / assets;
                        if (ratio >= 0.3) return "Excellent working capital - strong operational flexibility";
                        if (ratio >= 0.2) return "Good working capital - adequate operational buffer";
                        if (ratio >= 0.1) return "Adequate working capital - monitor cash flow";
                        if (amount > 0) return "Positive working capital - minimal operational buffer";
                        return "Negative working capital - immediate attention required";
                    }
                }
            },
            
            // TURNOVER/ACTIVITY RATIOS
            turnover: {
                inventory: {
                    formula: "Inventory Turnover = Cost of Goods Sold √∑ Average Inventory",
                    interpretation: (ratio) => {
                        if (ratio >= 12) return "Excellent inventory management - very efficient stock turnover";
                        if (ratio >= 8) return "Good inventory management - efficient operations";
                        if (ratio >= 4) return "Average inventory management - room for improvement";
                        if (ratio >= 2) return "Slow inventory turnover - review inventory policies";
                        return "Very slow turnover - excess inventory or poor sales";
                    }
                },
                receivables: {
                    formula: "Receivables Turnover = Net Credit Sales √∑ Average Accounts Receivable",
                    interpretation: (ratio) => {
                        if (ratio >= 12) return "Excellent collection efficiency - very fast receivables turnover";
                        if (ratio >= 8) return "Good collection efficiency - effective credit management";
                        if (ratio >= 6) return "Average collection efficiency - monitor credit policies";
                        if (ratio >= 4) return "Slow collection - review credit terms and collection procedures";
                        return "Very slow collection - significant collection issues";
                    }
                },
                asset: {
                    formula: "Asset Turnover = Net Sales √∑ Average Total Assets",
                    interpretation: (ratio) => {
                        if (ratio >= 2) return "Excellent asset utilization - very efficient use of assets";
                        if (ratio >= 1.5) return "Good asset utilization - effective asset management";
                        if (ratio >= 1) return "Average asset utilization - room for improvement";
                        if (ratio >= 0.5) return "Below average asset utilization - review asset efficiency";
                        return "Poor asset utilization - assets not generating sufficient sales";
                    }
                },
                equity: {
                    formula: "Equity Turnover = Net Sales √∑ Average Shareholders' Equity",
                    interpretation: (ratio) => {
                        if (ratio >= 4) return "High equity efficiency - very effective use of shareholder funds";
                        if (ratio >= 3) return "Good equity efficiency - effective shareholder value creation";
                        if (ratio >= 2) return "Average equity efficiency - moderate shareholder returns";
                        if (ratio >= 1) return "Below average equity efficiency - review capital structure";
                        return "Poor equity efficiency - inefficient use of shareholder capital";
                    }
                }
            },
            
            // LEVERAGE/SOLVENCY RATIOS
            leverage: {
                debtToEquity: {
                    formula: "Debt-to-Equity = Total Debt √∑ Total Equity",
                    interpretation: (ratio) => {
                        if (ratio >= 2) return "High leverage - significant financial risk, monitor closely";
                        if (ratio >= 1) return "Moderate leverage - balanced capital structure";
                        if (ratio >= 0.5) return "Conservative leverage - low financial risk";
                        if (ratio >= 0.2) return "Very conservative - minimal debt financing";
                        return "Debt-free - entirely equity financed";
                    }
                },
                debtToAssets: {
                    formula: "Debt-to-Assets = Total Debt √∑ Total Assets",
                    interpretation: (ratio) => {
                        if (ratio >= 0.6) return "High leverage - risky financial position";
                        if (ratio >= 0.4) return "Moderate leverage - acceptable risk level";
                        if (ratio >= 0.2) return "Conservative leverage - low financial risk";
                        if (ratio > 0) return "Very conservative - minimal debt usage";
                        return "Debt-free - no financial leverage";
                    }
                },
                interestCoverage: {
                    formula: "Interest Coverage = EBIT √∑ Interest Expense",
                    interpretation: (ratio) => {
                        if (ratio >= 10) return "Excellent interest coverage - very safe debt servicing ability";
                        if (ratio >= 5) return "Good interest coverage - comfortable debt servicing";
                        if (ratio >= 2.5) return "Adequate interest coverage - manageable debt burden";
                        if (ratio >= 1.5) return "Marginal interest coverage - monitor debt levels closely";
                        return "Poor interest coverage - difficulty meeting interest obligations";
                    }
                }
            },
            
            // PROFITABILITY RATIOS
            profitability: {
                roa: {
                    formula: "ROA = (Net Income √∑ Total Assets) √ó 100%",
                    interpretation: (ratio) => {
                        if (ratio >= 15) return "Excellent asset efficiency - outstanding profit generation";
                        if (ratio >= 10) return "Very good asset efficiency - strong profit performance";
                        if (ratio >= 5) return "Good asset utilization - healthy profit margins";
                        if (ratio >= 2) return "Average performance - room for improvement";
                        return "Below average - assets not generating sufficient returns";
                    }
                },
                roe: {
                    formula: "ROE = (Net Income √∑ Shareholders' Equity) √ó 100%",
                    interpretation: (ratio) => {
                        if (ratio >= 20) return "Excellent returns for shareholders - outstanding performance";
                        if (ratio >= 15) return "Very good shareholder returns - strong value creation";
                        if (ratio >= 10) return "Good shareholder returns - healthy performance";
                        if (ratio >= 5) return "Average performance - moderate returns";
                        return "Below average returns for shareholders";
                    }
                },
                grossProfit: {
                    formula: "Gross Profit Margin = (Gross Profit √∑ Revenue) √ó 100%",
                    interpretation: (ratio) => {
                        if (ratio >= 60) return "Excellent gross profitability - very strong pricing power";
                        if (ratio >= 40) return "Good gross profitability - healthy margins";
                        if (ratio >= 25) return "Average gross profitability - competitive position";
                        if (ratio >= 15) return "Below average margins - review pricing or costs";
                        return "Low profitability - significant cost or pricing issues";
                    }
                },
                operatingMargin: {
                    formula: "Operating Margin = (Operating Income √∑ Revenue) √ó 100%",
                    interpretation: (ratio) => {
                        if (ratio >= 25) return "Excellent operational efficiency - outstanding cost control";
                        if (ratio >= 15) return "Good operational efficiency - effective management";
                        if (ratio >= 8) return "Average operational efficiency - room for improvement";
                        if (ratio >= 3) return "Below average efficiency - review operations";
                        return "Poor operational efficiency - significant operational issues";
                    }
                },
                netMargin: {
                    formula: "Net Profit Margin = (Net Income √∑ Revenue) √ó 100%",
                    interpretation: (ratio) => {
                        if (ratio >= 20) return "Excellent net profitability - outstanding overall performance";
                        if (ratio >= 10) return "Good net profitability - strong bottom line";
                        if (ratio >= 5) return "Average net profitability - healthy performance";
                        if (ratio >= 2) return "Below average profitability - review all costs";
                        return "Poor net profitability - comprehensive review needed";
                    }
                }
            },
            
            // MARKET VALUE RATIOS
            marketValue: {
                pe: {
                    formula: "P/E Ratio = Market Price per Share √∑ Earnings per Share",
                    interpretation: (ratio) => {
                        if (ratio >= 30) return "High valuation - investors expect strong growth or stock may be overvalued";
                        if (ratio >= 20) return "Above average valuation - positive growth expectations";
                        if (ratio >= 15) return "Average valuation - fairly priced relative to earnings";
                        if (ratio >= 10) return "Below average valuation - may be undervalued or facing challenges";
                        return "Low valuation - potentially undervalued or poor earnings quality";
                    }
                },
                pb: {
                    formula: "P/B Ratio = Market Price per Share √∑ Book Value per Share",
                    interpretation: (ratio) => {
                        if (ratio >= 3) return "High market valuation - investors value intangible assets highly";
                        if (ratio >= 2) return "Above average valuation - positive market sentiment";
                        if (ratio >= 1) return "Fair valuation - trading near book value";
                        if (ratio >= 0.5) return "Below book value - potentially undervalued";
                        return "Significantly below book value - distressed or asset-rich company";
                    }
                },
                dividendYield: {
                    formula: "Dividend Yield = (Annual Dividends per Share √∑ Market Price per Share) √ó 100%",
                    interpretation: (ratio) => {
                        if (ratio >= 6) return "High dividend yield - mature company with strong cash flow or potential concerns";
                        if (ratio >= 4) return "Good dividend yield - attractive income investment";
                        if (ratio >= 2) return "Average dividend yield - moderate income potential";
                        if (ratio >= 1) return "Low dividend yield - growth-focused or capital appreciation strategy";
                        return "No dividend yield - company retains earnings for growth";
                    }
                }
            }
        };

        // Advanced AI Response Generator with Comprehensive Theory & Analytics
        function generateAIResponse(question) {
            const lowerQuestion = question.toLowerCase();
            
            // COMPREHENSIVE PATTERN MATCHING - Theory + Calculations + Analytics
            const patterns = {
                // FINANCIAL THEORY & CONCEPTS
                theory: {
                    financialManagement: ['financial management', 'finance theory', 'corporate finance', 'financial planning', 'capital structure'],
                    investmentTheory: ['investment theory', 'portfolio theory', 'capm', 'efficient market', 'risk return'],
                    behavioralFinance: ['behavioral finance', 'market psychology', 'investor behavior', 'cognitive bias'],
                    corporateGovernance: ['corporate governance', 'agency theory', 'stakeholder theory', 'board of directors'],
                    riskManagement: ['risk management', 'financial risk', 'credit risk', 'market risk', 'operational risk'],
                    capitalBudgeting: ['capital budgeting', 'npv', 'irr', 'project evaluation', 'investment appraisal'],
                    workingCapitalMgmt: ['working capital management', 'cash management', 'inventory management', 'credit policy'],
                    dividendPolicy: ['dividend policy', 'dividend theory', 'payout ratio', 'retention ratio'],
                    mergerAcquisition: ['merger', 'acquisition', 'takeover', 'corporate restructuring', 'synergy'],
                    internationalFinance: ['international finance', 'foreign exchange', 'currency risk', 'multinational finance']
                },
                
                // DATA ANALYTICS & STATISTICAL ANALYSIS
                analytics: {
                    descriptiveStats: ['mean', 'median', 'mode', 'standard deviation', 'variance', 'descriptive statistics'],
                    regression: ['regression', 'correlation', 'linear regression', 'multiple regression', 'r squared'],
                    hypothesis: ['hypothesis test', 't test', 'z test', 'chi square', 'anova', 'p value'],
                    timeSeries: ['time series', 'trend analysis', 'seasonal', 'forecasting', 'moving average'],
                    probability: ['probability', 'distribution', 'normal distribution', 'binomial', 'poisson'],
                    sampling: ['sampling', 'sample size', 'confidence interval', 'margin of error', 'population'],
                    dataVisualization: ['chart', 'graph', 'visualization', 'histogram', 'scatter plot'],
                    financialModeling: ['financial model', 'dcf model', 'valuation model', 'sensitivity analysis'],
                    riskAnalytics: ['var', 'value at risk', 'monte carlo', 'stress testing', 'scenario analysis'],
                    performanceMetrics: ['sharpe ratio', 'treynor ratio', 'jensen alpha', 'information ratio']
                },
                
                // TRADITIONAL CALCULATIONS (Enhanced)
                calculations: {
                    // LIQUIDITY RATIOS
                    currentRatio: ['current ratio', 'liquidity ratio', 'working capital ratio', 'current assets', 'current liabilities'],
                    quickRatio: ['quick ratio', 'acid test', 'liquid ratio', 'quick assets'],
                    cashRatio: ['cash ratio', 'cash position', 'immediate liquidity', 'cash equivalents'],
                    workingCapital: ['working capital', 'net working capital', 'operational capital'],
                    
                    // TURNOVER/ACTIVITY RATIOS
                    inventoryTurnover: ['inventory turnover', 'stock turnover', 'inventory efficiency', 'cogs inventory'],
                    receivablesTurnover: ['receivables turnover', 'accounts receivable turnover', 'collection efficiency', 'credit sales'],
                    assetTurnover: ['asset turnover', 'total asset turnover', 'asset efficiency', 'sales to assets'],
                    equityTurnover: ['equity turnover', 'shareholder equity turnover', 'equity efficiency'],
                    
                    // LEVERAGE/SOLVENCY RATIOS
                    debtToEquity: ['debt to equity', 'debt equity ratio', 'leverage ratio', 'financial leverage'],
                    debtToAssets: ['debt to assets', 'debt ratio', 'debt to total assets'],
                    interestCoverage: ['interest coverage', 'times interest earned', 'ebit interest', 'debt servicing'],
                    
                    // PROFITABILITY RATIOS
                    roa: ['roa', 'return on assets', 'asset efficiency', 'asset utilization', 'profit per asset'],
                    roe: ['roe', 'return on equity', 'shareholder return', 'equity efficiency', 'profit per equity'],
                    grossProfit: ['gross profit', 'gross margin', 'revenue minus cost', 'gross profitability'],
                    operatingMargin: ['operating margin', 'operating profit margin', 'ebit margin', 'operational efficiency'],
                    netMargin: ['net margin', 'net profit margin', 'net income margin', 'bottom line margin'],
                    
                    // MARKET VALUE RATIOS
                    peRatio: ['p/e ratio', 'price earnings', 'pe ratio', 'earnings multiple', 'market price eps'],
                    pbRatio: ['p/b ratio', 'price to book', 'pb ratio', 'market to book', 'book value ratio'],
                    dividendYield: ['dividend yield', 'dividend rate', 'dividend return', 'annual dividend'],
                    
                    // TIME VALUE & INTEREST
                    simpleInterest: ['simple interest', 'linear interest', 'basic interest'],
                    compoundInterest: ['compound interest', 'compounding', 'exponential growth', 'interest on interest'],
                    presentValue: ['present value', 'pv', 'current worth', 'today value', 'discounted value'],
                    futureValue: ['future value', 'fv', 'maturity value', 'accumulated value', 'growth value'],
                    annuity: ['annuity', 'regular payment', 'periodic payment', 'installment'],
                    
                    // ADVANCED CALCULATIONS
                    breakeven: ['break even', 'breakeven', 'no profit no loss'],
                    payback: ['payback period', 'recovery time', 'investment recovery'],
                    npv: ['npv', 'net present value', 'discounted cash flow'],
                    irr: ['irr', 'internal rate of return', 'yield'],
                    wacc: ['wacc', 'weighted average cost of capital', 'cost of capital'],
                    beta: ['beta', 'systematic risk', 'market risk', 'volatility'],
                    capm: ['capm calculation', 'capital asset pricing model', 'required return']
                }
            };

            // INTELLIGENT PATTERN DETECTION SYSTEM
            
            // PRIORITY 1: DIRECT CALCULATION DETECTION - Check for specific calculation patterns first
            for (const [type, keywords] of Object.entries(patterns.calculations)) {
                if (keywords.some(keyword => lowerQuestion.includes(keyword))) {
                    switch(type) {
                        // LIQUIDITY RATIOS
                        case 'currentRatio': return handleCurrentRatio(question);
                        case 'quickRatio': return handleQuickRatio(question);
                        case 'cashRatio': return handleCashRatio(question);
                        case 'workingCapital': return handleWorkingCapital(question);
                        
                        // TURNOVER RATIOS
                        case 'inventoryTurnover': return handleInventoryTurnover(question);
                        case 'receivablesTurnover': return handleReceivablesTurnover(question);
                        case 'assetTurnover': return handleAssetTurnover(question);
                        case 'equityTurnover': return handleEquityTurnover(question);
                        
                        // LEVERAGE RATIOS
                        case 'debtToEquity': return handleDebtToEquity(question);
                        case 'debtToAssets': return handleDebtToAssets(question);
                        case 'interestCoverage': return handleInterestCoverage(question);
                        
                        // PROFITABILITY RATIOS
                        case 'roa': return handleROA(question);
                        case 'roe': return handleROE(question);
                        case 'grossProfit': return handleGrossProfit(question);
                        case 'operatingMargin': return handleOperatingMargin(question);
                        case 'netMargin': return handleNetMargin(question);
                        
                        // MARKET VALUE RATIOS
                        case 'peRatio': return handlePERatio(question);
                        case 'pbRatio': return handlePBRatio(question);
                        case 'dividendYield': return handleDividendYield(question);
                        
                        // TIME VALUE & INTEREST
                        case 'simpleInterest': return handleSimpleInterest(question);
                        case 'compoundInterest': return handleCompoundInterest(question);
                        case 'presentValue': return handlePresentValue(question);
                        case 'futureValue': return handleFutureValue(question);
                        case 'annuity': return handleAnnuity(question);
                        
                        // ADVANCED CALCULATIONS
                        case 'breakeven': return handleBreakeven(question);
                        case 'payback': return handlePayback(question);
                        case 'npv': return handleNPV(question);
                        case 'irr': return handleIRR(question);
                        case 'wacc': return handleWACC(question);
                        case 'beta': return handleBeta(question);
                        case 'capm': return handleCAPM(question);
                    }
                }
            }
            
            // PRIORITY 2: THEORY QUESTIONS - Financial Concepts & Explanations
            for (const [topic, keywords] of Object.entries(patterns.theory)) {
                if (keywords.some(keyword => lowerQuestion.includes(keyword))) {
                    return handleTheoryQuestion(topic, question);
                }
            }
            
            // PRIORITY 3: ANALYTICS QUESTIONS - Statistical & Data Analysis
            for (const [topic, keywords] of Object.entries(patterns.analytics)) {
                if (keywords.some(keyword => lowerQuestion.includes(keyword))) {
                    return handleAnalyticsQuestion(topic, question);
                }
            }

        // ===== THEORY QUESTION HANDLERS =====
        
        function handleTheoryQuestion(topic, question) {
            const theoryDatabase = {
                financialManagement: {
                    title: "üìö Financial Management Theory",
                    definition: "Financial Management is the strategic planning, organizing, directing, and controlling of financial undertakings in an organization. It involves applying management principles to the financial assets of an organization.",
                    keyPoints: [
                        "**Primary Objective:** Maximize shareholder wealth through optimal financial decisions",
                        "**Core Functions:** Investment decisions, Financing decisions, Dividend decisions",
                        "**Key Principles:** Risk-return tradeoff, Time value of money, Cash flow focus",
                        "**Decision Areas:** Capital budgeting, Capital structure, Working capital management"
                    ],
                    applications: [
                        "Corporate investment analysis and project evaluation",
                        "Optimal capital structure determination",
                        "Working capital optimization for liquidity management",
                        "Dividend policy formulation and implementation"
                    ],
                    realWorld: "Companies like Apple use sophisticated financial management to maintain $200+ billion cash reserves while funding R&D and returning value to shareholders through dividends and buybacks."
                },
                
                investmentTheory: {
                    title: "üìà Investment Theory & Portfolio Management",
                    definition: "Investment Theory provides frameworks for making optimal investment decisions under uncertainty, focusing on risk-return relationships and portfolio optimization.",
                    keyPoints: [
                        "**Modern Portfolio Theory:** Diversification reduces risk without sacrificing return",
                        "**CAPM Model:** Expected return = Risk-free rate + Beta √ó Market risk premium",
                        "**Efficient Market Hypothesis:** Markets are informationally efficient",
                        "**Risk Types:** Systematic (market) risk vs. Unsystematic (specific) risk"
                    ],
                    applications: [
                        "Portfolio construction and asset allocation strategies",
                        "Risk assessment and management in investment decisions",
                        "Performance evaluation using risk-adjusted metrics",
                        "Hedge fund and mutual fund management strategies"
                    ],
                    realWorld: "Warren Buffett's Berkshire Hathaway applies value investing principles, while index funds use MPT for broad market diversification."
                },
                
                riskManagement: {
                    title: "‚ö†Ô∏è Financial Risk Management",
                    definition: "Risk Management involves identifying, analyzing, and mitigating financial risks that could negatively impact an organization's capital and earnings.",
                    keyPoints: [
                        "**Credit Risk:** Risk of counterparty default on obligations",
                        "**Market Risk:** Risk from adverse market movements (interest rates, FX, equity prices)",
                        "**Operational Risk:** Risk from internal processes, systems, or human errors",
                        "**Liquidity Risk:** Risk of inability to meet short-term obligations"
                    ],
                    applications: [
                        "Value-at-Risk (VaR) modeling for market risk quantification",
                        "Credit scoring and default probability estimation",
                        "Stress testing and scenario analysis",
                        "Derivative instruments for hedging strategies"
                    ],
                    realWorld: "JPMorgan Chase uses sophisticated risk models to manage $3+ trillion in assets, with daily VaR limits and comprehensive stress testing."
                },
                
                capitalBudgeting: {
                    title: "üèóÔ∏è Capital Budgeting & Investment Appraisal",
                    definition: "Capital Budgeting is the process of evaluating and selecting long-term investments that are consistent with the firm's goal of maximizing shareholder wealth.",
                    keyPoints: [
                        "**NPV Rule:** Accept projects with positive Net Present Value",
                        "**IRR Method:** Internal Rate of Return must exceed cost of capital",
                        "**Payback Period:** Time required to recover initial investment",
                        "**Profitability Index:** Present value of benefits per dollar invested"
                    ],
                    applications: [
                        "Manufacturing plant expansion decisions",
                        "Technology upgrade and automation projects",
                        "Research & development investment evaluation",
                        "Merger and acquisition financial analysis"
                    ],
                    realWorld: "Tesla's Gigafactory investments required extensive capital budgeting analysis, evaluating $5+ billion projects with 10+ year horizons."
                },
                
                behavioralFinance: {
                    title: "üß† Behavioral Finance & Market Psychology",
                    definition: "Behavioral Finance combines psychological insights with conventional financial theory to explain why people make irrational financial decisions.",
                    keyPoints: [
                        "**Cognitive Biases:** Overconfidence, anchoring, confirmation bias affect decisions",
                        "**Market Anomalies:** Momentum, value premium, size effect challenge EMH",
                        "**Herd Behavior:** Investors follow crowd, creating bubbles and crashes",
                        "**Loss Aversion:** People feel losses more acutely than equivalent gains"
                    ],
                    applications: [
                        "Investment strategy development accounting for behavioral biases",
                        "Market timing and contrarian investment approaches",
                        "Risk tolerance assessment and client advisory services",
                        "Corporate finance decisions considering management biases"
                    ],
                    realWorld: "The 2008 financial crisis and dot-com bubble demonstrate how behavioral factors can drive market irrationality and systemic risk."
                }
            };
            
            const theory = theoryDatabase[topic];
            if (!theory) {
                return generateGeneralTheoryResponse(topic, question);
            }
            
            return `
                <div class="step-box">
                    <h4 class="font-bold text-purple-600 mb-3">${theory.title}</h4>
                    <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500 mb-4">
                        <h5 class="font-semibold text-purple-700 mb-2">üìñ Definition</h5>
                        <p class="text-gray-700">${theory.definition}</p>
                    </div>
                </div>
                
                <div class="step-box">
                    <h4 class="font-bold text-blue-600 mb-3">üîë Key Concepts</h4>
                    <div class="space-y-2">
                        ${theory.keyPoints.map(point => `<div class="flex items-start gap-2">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></span>
                            <p class="text-gray-700">${point}</p>
                        </div>`).join('')}
                    </div>
                </div>
                
                <div class="step-box">
                    <h4 class="font-bold text-green-600 mb-3">üíº Practical Applications</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${theory.applications.map(app => `<div class="bg-green-50 p-3 rounded-lg border-l-3 border-green-400">
                            <p class="text-sm text-green-800">${app}</p>
                        </div>`).join('')}
                    </div>
                </div>
                
                <div class="step-box">
                    <h4 class="font-bold text-orange-600 mb-3">üåç Real-World Example</h4>
                    <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-400">
                        <p class="text-gray-700 italic">${theory.realWorld}</p>
                    </div>
                </div>
            `;
        }
        
        function handleAnalyticsQuestion(topic, question) {
            const analyticsDatabase = {
                descriptiveStats: {
                    title: "üìä Descriptive Statistics in Finance",
                    definition: "Descriptive statistics summarize and describe the main features of financial datasets, providing insights into central tendency, variability, and distribution shape.",
                    methods: [
                        "**Mean (Average):** Sum of values divided by count - sensitive to outliers",
                        "**Median:** Middle value when data is ordered - robust to outliers",
                        "**Mode:** Most frequently occurring value in the dataset",
                        "**Standard Deviation:** Measures variability around the mean",
                        "**Variance:** Square of standard deviation, measures dispersion",
                        "**Skewness:** Measures asymmetry of the distribution",
                        "**Kurtosis:** Measures tail heaviness of the distribution"
                    ],
                    applications: [
                        "Stock return analysis and risk assessment",
                        "Portfolio performance measurement and comparison",
                        "Credit risk modeling and default rate analysis",
                        "Market volatility and correlation studies"
                    ],
                    example: "For Apple stock returns: Mean = 12.5%, Std Dev = 18.2%, indicating moderate volatility with positive average returns."
                },
                
                regression: {
                    title: "üìà Regression Analysis in Finance",
                    definition: "Regression analysis examines relationships between variables, allowing prediction and understanding of how financial variables influence each other.",
                    methods: [
                        "**Simple Linear Regression:** Y = Œ± + Œ≤X + Œµ (one predictor variable)",
                        "**Multiple Regression:** Y = Œ± + Œ≤‚ÇÅX‚ÇÅ + Œ≤‚ÇÇX‚ÇÇ + ... + Œµ (multiple predictors)",
                        "**R-squared:** Proportion of variance explained by the model (0-100%)",
                        "**Beta Coefficient:** Change in Y for one unit change in X",
                        "**P-value:** Statistical significance of relationships",
                        "**Residual Analysis:** Checking model assumptions and fit quality"
                    ],
                    applications: [
                        "CAPM beta estimation for systematic risk measurement",
                        "Factor models for portfolio risk attribution",
                        "Credit scoring models for loan default prediction",
                        "Economic forecasting and scenario analysis"
                    ],
                    example: "Stock Beta = 1.2 means the stock moves 1.2% for every 1% market movement, indicating higher systematic risk."
                },
                
                timeSeries: {
                    title: "‚è∞ Time Series Analysis in Finance",
                    definition: "Time series analysis studies financial data points collected over time to identify patterns, trends, and make forecasts.",
                    methods: [
                        "**Trend Analysis:** Long-term directional movement in data",
                        "**Seasonal Patterns:** Regular, predictable fluctuations",
                        "**Moving Averages:** Smoothed data to identify underlying trends",
                        "**ARIMA Models:** Autoregressive Integrated Moving Average for forecasting",
                        "**Volatility Clustering:** Periods of high/low volatility tend to cluster",
                        "**Unit Root Tests:** Testing for stationarity in time series"
                    ],
                    applications: [
                        "Stock price forecasting and technical analysis",
                        "Economic indicator prediction and policy analysis",
                        "Risk management and volatility modeling",
                        "Algorithmic trading strategy development"
                    ],
                    example: "S&P 500 shows long-term upward trend with cyclical patterns, seasonal effects (January effect), and volatility clustering during crises."
                },
                
                riskAnalytics: {
                    title: "‚ö° Risk Analytics & Quantitative Methods",
                    definition: "Risk analytics uses statistical and mathematical models to quantify, measure, and manage various types of financial risk.",
                    methods: [
                        "**Value at Risk (VaR):** Maximum expected loss over specific time horizon",
                        "**Expected Shortfall (ES):** Average loss beyond VaR threshold",
                        "**Monte Carlo Simulation:** Random sampling for complex risk modeling",
                        "**Stress Testing:** Impact analysis under extreme market conditions",
                        "**Scenario Analysis:** Risk assessment under specific economic scenarios",
                        "**Copula Models:** Modeling dependence between risk factors"
                    ],
                    applications: [
                        "Bank capital adequacy and regulatory compliance",
                        "Portfolio risk management and optimization",
                        "Insurance pricing and reserve calculation",
                        "Derivative pricing and hedging strategies"
                    ],
                    example: "A portfolio's 1-day 95% VaR of $1M means there's a 5% chance of losing more than $1M in one day."
                },
                
                performanceMetrics: {
                    title: "üéØ Performance Analytics & Risk-Adjusted Returns",
                    definition: "Performance metrics evaluate investment returns while accounting for the risk taken to achieve those returns.",
                    methods: [
                        "**Sharpe Ratio:** (Return - Risk-free rate) / Standard deviation",
                        "**Treynor Ratio:** (Return - Risk-free rate) / Beta",
                        "**Jensen's Alpha:** Excess return over CAPM predicted return",
                        "**Information Ratio:** Active return / Tracking error",
                        "**Sortino Ratio:** Return / Downside deviation (only negative returns)",
                        "**Maximum Drawdown:** Largest peak-to-trough decline"
                    ],
                    applications: [
                        "Mutual fund and hedge fund performance evaluation",
                        "Portfolio manager skill assessment and ranking",
                        "Investment strategy comparison and selection",
                        "Risk-adjusted benchmarking and attribution analysis"
                    ],
                    example: "A Sharpe ratio of 1.5 indicates the portfolio generates 1.5 units of excess return per unit of risk taken."
                }
            };
            
            const analytics = analyticsDatabase[topic];
            if (!analytics) {
                return generateGeneralAnalyticsResponse(topic, question);
            }
            
            return `
                <div class="step-box">
                    <h4 class="font-bold text-blue-600 mb-3">${analytics.title}</h4>
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                        <h5 class="font-semibold text-blue-700 mb-2">üìä Overview</h5>
                        <p class="text-gray-700">${analytics.definition}</p>
                    </div>
                </div>
                
                <div class="step-box">
                    <h4 class="font-bold text-purple-600 mb-3">üî¨ Methods & Techniques</h4>
                    <div class="space-y-3">
                        ${analytics.methods.map(method => `<div class="bg-purple-50 p-3 rounded-lg border-l-3 border-purple-400">
                            <p class="text-gray-700 text-sm">${method}</p>
                        </div>`).join('')}
                    </div>
                </div>
                
                <div class="step-box">
                    <h4 class="font-bold text-green-600 mb-3">üí° Financial Applications</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${analytics.applications.map(app => `<div class="bg-green-50 p-3 rounded-lg">
                            <div class="flex items-start gap-2">
                                <span class="w-2 h-2 bg-green-500 rounded-full mt-2 flex-shrink-0"></span>
                                <p class="text-sm text-green-800">${app}</p>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>
                
                <div class="step-box">
                    <h4 class="font-bold text-orange-600 mb-3">üìà Practical Example</h4>
                    <div class="bg-orange-50 p-4 rounded-lg border-l-4 border-orange-400">
                        <p class="text-gray-700 font-medium">${analytics.example}</p>
                    </div>
                </div>
            `;
        }
        
        // Advanced Calculation Handlers
        
        function handleNPV(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 3) {
                const initialInvestment = numbers[0];
                const discountRate = numbers[1] / 100;
                const cashFlows = numbers.slice(2);
                
                let npv = -initialInvestment;
                let pvCashFlows = 0;
                
                cashFlows.forEach((cf, index) => {
                    const pv = cf / Math.pow(1 + discountRate, index + 1);
                    pvCashFlows += pv;
                    npv += pv;
                });
                
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Net Present Value (NPV) Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Initial Investment = ${formatCurrency(initialInvestment, currency)}</li>
                            <li>Discount Rate = ${(discountRate * 100).toFixed(1)}%</li>
                            <li>Cash Flows = ${cashFlows.map(cf => formatCurrency(cf, currency)).join(', ')}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> NPV = Œ£[CFt √∑ (1+r)^t] - Initial Investment
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        ${cashFlows.map((cf, index) => {
                            const pv = cf / Math.pow(1 + discountRate, index + 1);
                            return `<p><strong>Year ${index + 1}:</strong> ${formatCurrency(cf, currency)} √∑ (1.${(discountRate * 100).toFixed(0)})^${index + 1} = ${formatCurrency(pv, currency)}</p>`;
                        }).join('')}
                        <p><strong>Total PV of Cash Flows:</strong> ${formatCurrency(pvCashFlows, currency)}</p>
                        <p><strong>NPV:</strong> ${formatCurrency(pvCashFlows, currency)} - ${formatCurrency(initialInvestment, currency)} = ${formatCurrency(npv, currency)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Investment Decision:</h4>
                        <p><strong>NPV:</strong> ${formatCurrency(npv, currency)}</p>
                        <p><strong>Decision:</strong> ${npv > 0 ? '‚úÖ ACCEPT - Project creates value' : '‚ùå REJECT - Project destroys value'}</p>
                        <p><strong>Analysis:</strong> ${npv > 0 ? `Project adds ${formatCurrency(npv, currency)} in shareholder value` : `Project reduces shareholder value by ${formatCurrency(Math.abs(npv), currency)}`}</p>
                    </div>
                `;
            }
            return `I can help calculate NPV! Please provide: initial investment, discount rate (%), and future cash flows for each year.`;
        }
        
        function handleWACC(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 5) {
                const equity = numbers[0];
                const debt = numbers[1];
                const costOfEquity = numbers[2] / 100;
                const costOfDebt = numbers[3] / 100;
                const taxRate = numbers[4] / 100;
                
                const totalCapital = equity + debt;
                const equityWeight = equity / totalCapital;
                const debtWeight = debt / totalCapital;
                const afterTaxCostOfDebt = costOfDebt * (1 - taxRate);
                const wacc = (equityWeight * costOfEquity) + (debtWeight * afterTaxCostOfDebt);
                
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Weighted Average Cost of Capital (WACC)</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Market Value of Equity = ${formatCurrency(equity, currency)}</li>
                            <li>Market Value of Debt = ${formatCurrency(debt, currency)}</li>
                            <li>Cost of Equity = ${(costOfEquity * 100).toFixed(1)}%</li>
                            <li>Cost of Debt = ${(costOfDebt * 100).toFixed(1)}%</li>
                            <li>Tax Rate = ${(taxRate * 100).toFixed(1)}%</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> WACC = (E/V √ó Re) + (D/V √ó Rd √ó (1-T))<br>
                        Where: E = Equity, D = Debt, V = Total Value, Re = Cost of Equity, Rd = Cost of Debt, T = Tax Rate
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Calculate total capital</p>
                        <p>Total Capital = ${formatCurrency(equity, currency)} + ${formatCurrency(debt, currency)} = ${formatCurrency(totalCapital, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate weights</p>
                        <p>Equity Weight = ${formatCurrency(equity, currency)} √∑ ${formatCurrency(totalCapital, currency)} = ${(equityWeight * 100).toFixed(1)}%</p>
                        <p>Debt Weight = ${formatCurrency(debt, currency)} √∑ ${formatCurrency(totalCapital, currency)} = ${(debtWeight * 100).toFixed(1)}%</p>
                        <p><strong>Step 3:</strong> Calculate after-tax cost of debt</p>
                        <p>After-tax Cost of Debt = ${(costOfDebt * 100).toFixed(1)}% √ó (1 - ${(taxRate * 100).toFixed(1)}%) = ${(afterTaxCostOfDebt * 100).toFixed(2)}%</p>
                        <p><strong>Step 4:</strong> Calculate WACC</p>
                        <p>WACC = (${(equityWeight * 100).toFixed(1)}% √ó ${(costOfEquity * 100).toFixed(1)}%) + (${(debtWeight * 100).toFixed(1)}% √ó ${(afterTaxCostOfDebt * 100).toFixed(2)}%)</p>
                        <p>WACC = ${(wacc * 100).toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>WACC:</strong> ${(wacc * 100).toFixed(2)}%</p>
                        <p><strong>Meaning:</strong> The company's average cost of capital is ${(wacc * 100).toFixed(2)}% - this is the minimum return required for new projects.</p>
                        <p><strong>Usage:</strong> Use as discount rate for NPV calculations and investment decisions.</p>
                    </div>
                `;
            }
            return `I can help calculate WACC! Please provide: market value of equity, market value of debt, cost of equity (%), cost of debt (%), and tax rate (%).`;
        }
        
        function handleIRR(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const initialInvestment = numbers[0];
                const cashFlows = numbers.slice(1);
                
                // Simple IRR approximation for demonstration
                let irr = 0.1; // Start with 10% guess
                const maxIterations = 100;
                const tolerance = 0.0001;
                
                for (let i = 0; i < maxIterations; i++) {
                    let npv = -initialInvestment;
                    let derivative = 0;
                    
                    cashFlows.forEach((cf, index) => {
                        const period = index + 1;
                        npv += cf / Math.pow(1 + irr, period);
                        derivative -= (period * cf) / Math.pow(1 + irr, period + 1);
                    });
                    
                    if (Math.abs(npv) < tolerance) break;
                    irr = irr - npv / derivative;
                }
                
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Internal Rate of Return (IRR) Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Initial Investment = ${formatCurrency(initialInvestment, currency)}</li>
                            <li>Cash Flows = ${cashFlows.map(cf => formatCurrency(cf, currency)).join(', ')}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> 0 = Œ£[CFt √∑ (1+IRR)^t] - Initial Investment<br>
                        <strong>Method:</strong> Newton-Raphson iterative solution
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Solution Process:</h4>
                        <p><strong>IRR Calculation:</strong> Using iterative method to find rate where NPV = 0</p>
                        <p><strong>Calculated IRR:</strong> ${(irr * 100).toFixed(2)}%</p>
                        <p><strong>Verification:</strong> At ${(irr * 100).toFixed(2)}%, NPV ‚âà 0</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Investment Decision:</h4>
                        <p><strong>IRR:</strong> ${(irr * 100).toFixed(2)}%</p>
                        <p><strong>Decision Rule:</strong> Compare IRR to required rate of return (cost of capital)</p>
                        <p><strong>Analysis:</strong> If IRR > Cost of Capital, accept the project. If IRR < Cost of Capital, reject the project.</p>
                        <p><strong>Meaning:</strong> This project generates ${(irr * 100).toFixed(2)}% annual return on investment.</p>
                    </div>
                `;
            }
            return `I can help calculate IRR! Please provide: initial investment and future cash flows for each year.`;
        }
        
        function handleBeta(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const stockReturns = numbers.slice(0, Math.floor(numbers.length/2));
                const marketReturns = numbers.slice(Math.floor(numbers.length/2));
                
                if (stockReturns.length === marketReturns.length && stockReturns.length > 1) {
                    // Calculate means
                    const stockMean = stockReturns.reduce((a, b) => a + b) / stockReturns.length;
                    const marketMean = marketReturns.reduce((a, b) => a + b) / marketReturns.length;
                    
                    // Calculate covariance and market variance
                    let covariance = 0;
                    let marketVariance = 0;
                    
                    for (let i = 0; i < stockReturns.length; i++) {
                        covariance += (stockReturns[i] - stockMean) * (marketReturns[i] - marketMean);
                        marketVariance += Math.pow(marketReturns[i] - marketMean, 2);
                    }
                    
                    covariance /= (stockReturns.length - 1);
                    marketVariance /= (marketReturns.length - 1);
                    
                    const beta = covariance / marketVariance;
                    
                    return `
                        <div class="step-box">
                            <h4 class="font-bold text-purple-600 mb-2">üßÆ Beta Coefficient Calculation</h4>
                            <p><strong>Given:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                                <li>Stock Returns = ${stockReturns.map(r => r.toFixed(1) + '%').join(', ')}</li>
                                <li>Market Returns = ${marketReturns.map(r => r.toFixed(1) + '%').join(', ')}</li>
                            </ul>
                        </div>
                        
                        <div class="formula-box">
                            <strong>Formula:</strong> Œ≤ = Covariance(Stock, Market) √∑ Variance(Market)
                        </div>
                        
                        <div class="step-box">
                            <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                            <p><strong>Step 1:</strong> Calculate means</p>
                            <p>Stock Mean = ${stockMean.toFixed(2)}%, Market Mean = ${marketMean.toFixed(2)}%</p>
                            <p><strong>Step 2:</strong> Calculate covariance and market variance</p>
                            <p>Covariance = ${covariance.toFixed(4)}</p>
                            <p>Market Variance = ${marketVariance.toFixed(4)}</p>
                            <p><strong>Step 3:</strong> Calculate Beta</p>
                            <p>Œ≤ = ${covariance.toFixed(4)} √∑ ${marketVariance.toFixed(4)} = ${beta.toFixed(3)}</p>
                        </div>
                        
                        <div class="step-box">
                            <h4 class="font-bold text-green-600 mb-2">üí° Risk Interpretation:</h4>
                            <p><strong>Beta:</strong> ${beta.toFixed(3)}</p>
                            <p><strong>Risk Level:</strong> ${beta > 1.2 ? 'High Risk - More volatile than market' : beta > 0.8 ? 'Moderate Risk - Similar to market volatility' : 'Low Risk - Less volatile than market'}</p>
                            <p><strong>Meaning:</strong> For every 1% market movement, this stock moves approximately ${(beta * 100).toFixed(1)}%</p>
                        </div>
                    `;
                }
            }
            return `I can help calculate Beta! Please provide paired stock returns and market returns (same number of periods for each).`;
        }
        
        function handleCAPM(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 3) {
                const riskFreeRate = numbers[0] / 100;
                const beta = numbers[1];
                const marketReturn = numbers[2] / 100;
                
                const marketRiskPremium = marketReturn - riskFreeRate;
                const expectedReturn = riskFreeRate + (beta * marketRiskPremium);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ CAPM Expected Return Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Risk-free Rate = ${(riskFreeRate * 100).toFixed(1)}%</li>
                            <li>Beta = ${beta.toFixed(2)}</li>
                            <li>Market Return = ${(marketReturn * 100).toFixed(1)}%</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>CAPM Formula:</strong> E(R) = Rf + Œ≤ √ó (Rm - Rf)<br>
                        Where: E(R) = Expected Return, Rf = Risk-free Rate, Œ≤ = Beta, Rm = Market Return
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Calculate market risk premium</p>
                        <p>Market Risk Premium = ${(marketReturn * 100).toFixed(1)}% - ${(riskFreeRate * 100).toFixed(1)}% = ${(marketRiskPremium * 100).toFixed(1)}%</p>
                        <p><strong>Step 2:</strong> Apply CAPM formula</p>
                        <p>E(R) = ${(riskFreeRate * 100).toFixed(1)}% + ${beta.toFixed(2)} √ó ${(marketRiskPremium * 100).toFixed(1)}%</p>
                        <p><strong>Step 3:</strong> Calculate expected return</p>
                        <p>E(R) = ${(riskFreeRate * 100).toFixed(1)}% + ${(beta * marketRiskPremium * 100).toFixed(2)}% = ${(expectedReturn * 100).toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Investment Analysis:</h4>
                        <p><strong>Expected Return:</strong> ${(expectedReturn * 100).toFixed(2)}%</p>
                        <p><strong>Risk Assessment:</strong> ${beta > 1 ? 'Higher risk than market average' : beta < 1 ? 'Lower risk than market average' : 'Same risk as market average'}</p>
                        <p><strong>Usage:</strong> Use this return as the required rate for DCF valuations and investment decisions.</p>
                    </div>
                `;
            }
            return `I can help calculate CAPM expected return! Please provide: risk-free rate (%), beta coefficient, and market return (%).`;
        }
        
        function generateGeneralTheoryResponse(topic, question) {
            return `
                <div class="step-box">
                    <h4 class="font-bold text-purple-600 mb-3">üìö Financial Theory Analysis</h4>
                    <p>I can provide comprehensive explanations on various financial theories and concepts:</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                        <div class="bg-purple-50 p-3 rounded-lg border-l-3 border-purple-400">
                            <h5 class="font-semibold text-purple-700">Corporate Finance</h5>
                            <p class="text-sm text-gray-600">Capital structure, dividend policy, working capital management</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg border-l-3 border-blue-400">
                            <h5 class="font-semibold text-blue-700">Investment Theory</h5>
                            <p class="text-sm text-gray-600">Portfolio theory, CAPM, efficient markets, risk-return</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border-l-3 border-green-400">
                            <h5 class="font-semibold text-green-700">Risk Management</h5>
                            <p class="text-sm text-gray-600">Credit risk, market risk, operational risk, VaR</p>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg border-l-3 border-orange-400">
                            <h5 class="font-semibold text-orange-700">Behavioral Finance</h5>
                            <p class="text-sm text-gray-600">Cognitive biases, market anomalies, investor psychology</p>
                        </div>
                    </div>
                    
                    <p class="mt-4 text-sm bg-gray-100 p-3 rounded">
                        <strong>Ask me about:</strong> "Explain capital structure theory" or "What is behavioral finance?" for detailed analysis.
                    </p>
                </div>
            `;
        }
        
        function generateGeneralAnalyticsResponse(topic, question) {
            return `
                <div class="step-box">
                    <h4 class="font-bold text-blue-600 mb-3">üìä Financial Analytics & Data Science</h4>
                    <p>I can help with statistical analysis and quantitative methods in finance:</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                        <div class="bg-blue-50 p-3 rounded-lg border-l-3 border-blue-400">
                            <h5 class="font-semibold text-blue-700">Descriptive Statistics</h5>
                            <p class="text-sm text-gray-600">Mean, median, standard deviation, correlation analysis</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg border-l-3 border-purple-400">
                            <h5 class="font-semibold text-purple-700">Regression Analysis</h5>
                            <p class="text-sm text-gray-600">Linear regression, multiple regression, factor models</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg border-l-3 border-green-400">
                            <h5 class="font-semibold text-green-700">Time Series</h5>
                            <p class="text-sm text-gray-600">Trend analysis, forecasting, volatility modeling</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg border-l-3 border-red-400">
                            <h5 class="font-semibold text-red-700">Risk Analytics</h5>
                            <p class="text-sm text-gray-600">VaR, Monte Carlo, stress testing, scenario analysis</p>
                        </div>
                    </div>
                    
                    <p class="mt-4 text-sm bg-gray-100 p-3 rounded">
                        <strong>Ask me about:</strong> "How to calculate correlation?" or "Explain regression analysis" for detailed methods.
                    </p>
                </div>
            `;
        }
        
        // ===== LIQUIDITY RATIO HANDLERS =====
        
        function handleCashRatio(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const cash = numbers[0];
                const liabilities = numbers[1];
                const ratio = cash / liabilities;
                const interpretation = financialKnowledge.liquidity.cash.interpretation(ratio);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Cash Ratio Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Cash + Cash Equivalents = ${formatCurrency(cash, currency)}</li>
                            <li>Current Liabilities = ${formatCurrency(liabilities, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.liquidity.cash.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Cash Ratio = ${formatCurrency(cash, currency)} √∑ ${formatCurrency(liabilities, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Cash Ratio = ${ratio.toFixed(3)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${ratio.toFixed(3)}</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The company can cover ${(ratio * 100).toFixed(1)}% of current liabilities with immediate cash.</p>
                    </div>
                `;
            }
            return `I can help calculate cash ratio! Please provide cash + cash equivalents and current liabilities amounts.`;
        }

        function handleWorkingCapital(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const assets = numbers[0];
                const liabilities = numbers[1];
                const workingCapital = assets - liabilities;
                const interpretation = financialKnowledge.liquidity.workingCapital.interpretation(workingCapital, assets);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Working Capital Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Current Assets = ${formatCurrency(assets, currency)}</li>
                            <li>Current Liabilities = ${formatCurrency(liabilities, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.liquidity.workingCapital.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Working Capital = ${formatCurrency(assets, currency)} - ${formatCurrency(liabilities, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Working Capital = ${formatCurrency(workingCapital, currency)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${formatCurrency(workingCapital, currency)}</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> ${workingCapital > 0 ? 'Positive working capital indicates good short-term financial health.' : 'Negative working capital may indicate liquidity challenges.'}</p>
                    </div>
                `;
            }
            return `I can help calculate working capital! Please provide current assets and current liabilities amounts.`;
        }

        // ===== TURNOVER RATIO HANDLERS =====
        
        function handleInventoryTurnover(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const cogs = numbers[0];
                const inventory = numbers[1];
                const turnover = cogs / inventory;
                const daysInInventory = 365 / turnover;
                const interpretation = financialKnowledge.turnover.inventory.interpretation(turnover);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Inventory Turnover Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Cost of Goods Sold = ${formatCurrency(cogs, currency)}</li>
                            <li>Average Inventory = ${formatCurrency(inventory, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.turnover.inventory.formula}<br>
                        <strong>Days in Inventory:</strong> 365 √∑ Inventory Turnover
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Calculate inventory turnover</p>
                        <p>Inventory Turnover = ${formatCurrency(cogs, currency)} √∑ ${formatCurrency(inventory, currency)} = ${turnover.toFixed(2)} times</p>
                        <p><strong>Step 2:</strong> Calculate days in inventory</p>
                        <p>Days in Inventory = 365 √∑ ${turnover.toFixed(2)} = ${daysInInventory.toFixed(1)} days</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Turnover:</strong> ${turnover.toFixed(2)} times per year</p>
                        <p><strong>Days in Inventory:</strong> ${daysInInventory.toFixed(1)} days</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> Inventory is converted to sales ${turnover.toFixed(2)} times per year, taking ${daysInInventory.toFixed(1)} days on average.</p>
                    </div>
                `;
            }
            return `I can help calculate inventory turnover! Please provide cost of goods sold and average inventory amounts.`;
        }

        function handleReceivablesTurnover(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const sales = numbers[0];
                const receivables = numbers[1];
                const turnover = sales / receivables;
                const daysInReceivables = 365 / turnover;
                const interpretation = financialKnowledge.turnover.receivables.interpretation(turnover);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Receivables Turnover Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Net Credit Sales = ${formatCurrency(sales, currency)}</li>
                            <li>Average Accounts Receivable = ${formatCurrency(receivables, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.turnover.receivables.formula}<br>
                        <strong>Collection Period:</strong> 365 √∑ Receivables Turnover
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Calculate receivables turnover</p>
                        <p>Receivables Turnover = ${formatCurrency(sales, currency)} √∑ ${formatCurrency(receivables, currency)} = ${turnover.toFixed(2)} times</p>
                        <p><strong>Step 2:</strong> Calculate collection period</p>
                        <p>Collection Period = 365 √∑ ${turnover.toFixed(2)} = ${daysInReceivables.toFixed(1)} days</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Turnover:</strong> ${turnover.toFixed(2)} times per year</p>
                        <p><strong>Collection Period:</strong> ${daysInReceivables.toFixed(1)} days</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> Receivables are collected ${turnover.toFixed(2)} times per year, taking ${daysInReceivables.toFixed(1)} days on average.</p>
                    </div>
                `;
            }
            return `I can help calculate receivables turnover! Please provide net credit sales and average accounts receivable amounts.`;
        }

        function handleAssetTurnover(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const sales = numbers[0];
                const assets = numbers[1];
                const turnover = sales / assets;
                const interpretation = financialKnowledge.turnover.asset.interpretation(turnover);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Asset Turnover Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Net Sales = ${formatCurrency(sales, currency)}</li>
                            <li>Average Total Assets = ${formatCurrency(assets, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.turnover.asset.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Asset Turnover = ${formatCurrency(sales, currency)} √∑ ${formatCurrency(assets, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Asset Turnover = ${turnover.toFixed(2)} times</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${turnover.toFixed(2)} times</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The company generates ${currency === 'INR' ? '‚Çπ' : '$'}${turnover.toFixed(2)} in sales for every ${currency === 'INR' ? '‚Çπ1' : '$1'} of assets.</p>
                    </div>
                `;
            }
            return `I can help calculate asset turnover! Please provide net sales and average total assets amounts.`;
        }

        function handleEquityTurnover(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const sales = numbers[0];
                const equity = numbers[1];
                const turnover = sales / equity;
                const interpretation = financialKnowledge.turnover.equity.interpretation(turnover);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Equity Turnover Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Net Sales = ${formatCurrency(sales, currency)}</li>
                            <li>Average Shareholders' Equity = ${formatCurrency(equity, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.turnover.equity.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Equity Turnover = ${formatCurrency(sales, currency)} √∑ ${formatCurrency(equity, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Equity Turnover = ${turnover.toFixed(2)} times</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${turnover.toFixed(2)} times</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The company generates ${currency === 'INR' ? '‚Çπ' : '$'}${turnover.toFixed(2)} in sales for every ${currency === 'INR' ? '‚Çπ1' : '$1'} of equity.</p>
                    </div>
                `;
            }
            return `I can help calculate equity turnover! Please provide net sales and average shareholders' equity amounts.`;
        }

        // ===== LEVERAGE RATIO HANDLERS =====
        
        function handleDebtToEquity(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const debt = numbers[0];
                const equity = numbers[1];
                const ratio = debt / equity;
                const interpretation = financialKnowledge.leverage.debtToEquity.interpretation(ratio);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Debt-to-Equity Ratio Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Total Debt = ${formatCurrency(debt, currency)}</li>
                            <li>Total Equity = ${formatCurrency(equity, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.leverage.debtToEquity.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Debt-to-Equity = ${formatCurrency(debt, currency)} √∑ ${formatCurrency(equity, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Debt-to-Equity = ${ratio.toFixed(2)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${ratio.toFixed(2)}</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> For every ${currency === 'INR' ? '‚Çπ1' : '$1'} of equity, the company has ${currency === 'INR' ? '‚Çπ' : '$'}${ratio.toFixed(2)} of debt.</p>
                    </div>
                `;
            }
            return `I can help calculate debt-to-equity ratio! Please provide total debt and total equity amounts.`;
        }

        function handleInterestCoverage(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const ebit = numbers[0];
                const interest = numbers[1];
                const ratio = ebit / interest;
                const interpretation = financialKnowledge.leverage.interestCoverage.interpretation(ratio);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Interest Coverage Ratio Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>EBIT = ${formatCurrency(ebit, currency)}</li>
                            <li>Interest Expense = ${formatCurrency(interest, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.leverage.interestCoverage.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Interest Coverage = ${formatCurrency(ebit, currency)} √∑ ${formatCurrency(interest, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Interest Coverage = ${ratio.toFixed(2)} times</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${ratio.toFixed(2)} times</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The company can cover its interest payments ${ratio.toFixed(2)} times with current earnings.</p>
                    </div>
                `;
            }
            return `I can help calculate interest coverage ratio! Please provide EBIT and interest expense amounts.`;
        }

        // ===== PROFITABILITY RATIO HANDLERS =====
        
        function handleROA(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const netIncome = numbers[0];
                const totalAssets = numbers[1];
                const roa = (netIncome / totalAssets) * 100;
                const interpretation = financialKnowledge.profitability.roa.interpretation(roa);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Return on Assets (ROA) Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Net Income = ${formatCurrency(netIncome, currency)}</li>
                            <li>Total Assets = ${formatCurrency(totalAssets, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.profitability.roa.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>ROA = (${formatCurrency(netIncome, currency)} √∑ ${formatCurrency(totalAssets, currency)}) √ó 100%</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>ROA = ${(netIncome/totalAssets).toFixed(4)} √ó 100% = ${roa.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${roa.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The company generates ${currency === 'INR' ? '‚Çπ' : '$'}${roa.toFixed(2)} of profit for every ${currency === 'INR' ? '‚Çπ100' : '$100'} of assets.</p>
                    </div>
                `;
            }
            return `I can help calculate ROA! Please provide net income and total assets amounts.`;
        }

        function handleROE(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const netIncome = numbers[0];
                const equity = numbers[1];
                const roe = (netIncome / equity) * 100;
                const interpretation = financialKnowledge.profitability.roe.interpretation(roe);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Return on Equity (ROE) Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Net Income = ${formatCurrency(netIncome, currency)}</li>
                            <li>Shareholders' Equity = ${formatCurrency(equity, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.profitability.roe.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>ROE = (${formatCurrency(netIncome, currency)} √∑ ${formatCurrency(equity, currency)}) √ó 100%</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>ROE = ${(netIncome/equity).toFixed(4)} √ó 100% = ${roe.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${roe.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> Shareholders earn ${roe.toFixed(2)}% return on their investment.</p>
                    </div>
                `;
            }
            return `I can help calculate ROE! Please provide net income and shareholders' equity amounts.`;
        }

        function handleOperatingMargin(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const operatingIncome = numbers[0];
                const revenue = numbers[1];
                const margin = (operatingIncome / revenue) * 100;
                const interpretation = financialKnowledge.profitability.operatingMargin.interpretation(margin);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Operating Margin Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Operating Income = ${formatCurrency(operatingIncome, currency)}</li>
                            <li>Revenue = ${formatCurrency(revenue, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.profitability.operatingMargin.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Operating Margin = (${formatCurrency(operatingIncome, currency)} √∑ ${formatCurrency(revenue, currency)}) √ó 100%</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Operating Margin = ${(operatingIncome/revenue).toFixed(4)} √ó 100% = ${margin.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${margin.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The company retains ${currency === 'INR' ? '‚Çπ' : '$'}${margin.toFixed(2)} as operating profit for every ${currency === 'INR' ? '‚Çπ100' : '$100'} of revenue.</p>
                    </div>
                `;
            }
            return `I can help calculate operating margin! Please provide operating income and revenue amounts.`;
        }

        function handleNetMargin(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const netIncome = numbers[0];
                const revenue = numbers[1];
                const margin = (netIncome / revenue) * 100;
                const interpretation = financialKnowledge.profitability.netMargin.interpretation(margin);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Net Profit Margin Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Net Income = ${formatCurrency(netIncome, currency)}</li>
                            <li>Revenue = ${formatCurrency(revenue, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.profitability.netMargin.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Net Margin = (${formatCurrency(netIncome, currency)} √∑ ${formatCurrency(revenue, currency)}) √ó 100%</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Net Margin = ${(netIncome/revenue).toFixed(4)} √ó 100% = ${margin.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${margin.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The company retains ${currency === 'INR' ? '‚Çπ' : '$'}${margin.toFixed(2)} as net profit for every ${currency === 'INR' ? '‚Çπ100' : '$100'} of revenue.</p>
                    </div>
                `;
            }
            return `I can help calculate net profit margin! Please provide net income and revenue amounts.`;
        }

        // ===== MARKET VALUE RATIO HANDLERS =====
        
        function handlePERatio(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const marketPrice = numbers[0];
                const eps = numbers[1];
                const ratio = marketPrice / eps;
                const interpretation = financialKnowledge.marketValue.pe.interpretation(ratio);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ P/E Ratio Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Market Price per Share = ${formatCurrency(marketPrice, currency)}</li>
                            <li>Earnings per Share (EPS) = ${formatCurrency(eps, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.marketValue.pe.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>P/E Ratio = ${formatCurrency(marketPrice, currency)} √∑ ${formatCurrency(eps, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>P/E Ratio = ${ratio.toFixed(2)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${ratio.toFixed(2)}</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> Investors are willing to pay ${currency === 'INR' ? '‚Çπ' : '$'}${ratio.toFixed(2)} for every ${currency === 'INR' ? '‚Çπ1' : '$1'} of annual earnings.</p>
                    </div>
                `;
            }
            return `I can help calculate P/E ratio! Please provide market price per share and earnings per share amounts.`;
        }

        function handlePBRatio(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const marketPrice = numbers[0];
                const bookValue = numbers[1];
                const ratio = marketPrice / bookValue;
                const interpretation = financialKnowledge.marketValue.pb.interpretation(ratio);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ P/B Ratio Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Market Price per Share = ${formatCurrency(marketPrice, currency)}</li>
                            <li>Book Value per Share = ${formatCurrency(bookValue, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.marketValue.pb.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>P/B Ratio = ${formatCurrency(marketPrice, currency)} √∑ ${formatCurrency(bookValue, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>P/B Ratio = ${ratio.toFixed(2)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${ratio.toFixed(2)}</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The market values the company at ${ratio.toFixed(2)} times its book value.</p>
                    </div>
                `;
            }
            return `I can help calculate P/B ratio! Please provide market price per share and book value per share amounts.`;
        }

        function handleDividendYield(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const dividend = numbers[0];
                const marketPrice = numbers[1];
                const yield = (dividend / marketPrice) * 100;
                const interpretation = financialKnowledge.marketValue.dividendYield.interpretation(yield);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Dividend Yield Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Annual Dividend per Share = ${formatCurrency(dividend, currency)}</li>
                            <li>Market Price per Share = ${formatCurrency(marketPrice, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.marketValue.dividendYield.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Dividend Yield = (${formatCurrency(dividend, currency)} √∑ ${formatCurrency(marketPrice, currency)}) √ó 100%</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Dividend Yield = ${(dividend/marketPrice).toFixed(4)} √ó 100% = ${yield.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${yield.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> Investors receive ${yield.toFixed(2)}% annual return through dividends.</p>
                    </div>
                `;
            }
            return `I can help calculate dividend yield! Please provide annual dividend per share and market price per share amounts.`;
        }

        // ===== OTHER FINANCIAL CALCULATIONS =====
        
        function handleBreakeven(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 3) {
                const fixedCosts = numbers[0];
                const pricePerUnit = numbers[1];
                const variableCostPerUnit = numbers[2];
                const breakevenUnits = fixedCosts / (pricePerUnit - variableCostPerUnit);
                const breakevenRevenue = breakevenUnits * pricePerUnit;
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Break-Even Analysis</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Fixed Costs = ${formatCurrency(fixedCosts, currency)}</li>
                            <li>Price per Unit = ${formatCurrency(pricePerUnit, currency)}</li>
                            <li>Variable Cost per Unit = ${formatCurrency(variableCostPerUnit, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> Break-Even Units = Fixed Costs √∑ (Price per Unit - Variable Cost per Unit)
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Calculate contribution margin per unit</p>
                        <p>Contribution Margin = ${formatCurrency(pricePerUnit, currency)} - ${formatCurrency(variableCostPerUnit, currency)} = ${formatCurrency(pricePerUnit - variableCostPerUnit, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate break-even units</p>
                        <p>Break-Even Units = ${formatCurrency(fixedCosts, currency)} √∑ ${formatCurrency(pricePerUnit - variableCostPerUnit, currency)} = ${Math.round(breakevenUnits)} units</p>
                        <p><strong>Step 3:</strong> Calculate break-even revenue</p>
                        <p>Break-Even Revenue = ${Math.round(breakevenUnits)} √ó ${formatCurrency(pricePerUnit, currency)} = ${formatCurrency(breakevenRevenue, currency)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                        <p><strong>Break-Even Units:</strong> ${Math.round(breakevenUnits)} units</p>
                        <p><strong>Break-Even Revenue:</strong> ${formatCurrency(breakevenRevenue, currency)}</p>
                        <p><strong>Meaning:</strong> The company needs to sell ${Math.round(breakevenUnits)} units to cover all costs and reach break-even point.</p>
                    </div>
                `;
            }
            return `I can help calculate break-even point! Please provide fixed costs, price per unit, and variable cost per unit.`;
        }

        function handlePayback(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const initialInvestment = numbers[0];
                const annualCashFlow = numbers[1];
                const paybackPeriod = initialInvestment / annualCashFlow;
                const years = Math.floor(paybackPeriod);
                const months = Math.round((paybackPeriod - years) * 12);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Payback Period Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Initial Investment = ${formatCurrency(initialInvestment, currency)}</li>
                            <li>Annual Cash Flow = ${formatCurrency(annualCashFlow, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> Payback Period = Initial Investment √∑ Annual Cash Flow
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Payback Period = ${formatCurrency(initialInvestment, currency)} √∑ ${formatCurrency(annualCashFlow, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Payback Period = ${paybackPeriod.toFixed(2)} years</p>
                        <p><strong>Step 3:</strong> Convert to years and months</p>
                        <p>Payback Period = ${years} years and ${months} months</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                        <p><strong>Payback Period:</strong> ${years} years and ${months} months</p>
                        <p><strong>Analysis:</strong> ${paybackPeriod <= 2 ? 'Excellent - very quick recovery' : paybackPeriod <= 4 ? 'Good - reasonable recovery time' : paybackPeriod <= 6 ? 'Average - acceptable recovery period' : 'Long recovery period - consider other investments'}</p>
                        <p><strong>Meaning:</strong> It will take ${years} years and ${months} months to recover the initial investment.</p>
                    </div>
                `;
            }
            return `I can help calculate payback period! Please provide initial investment and annual cash flow amounts.`;
        }

        function handleDebtToAssets(question) {
            const numbers = extractNumbers(question);
            const lowerQuestion = question.toLowerCase();
            
            // Check for comprehensive multi-step problem
            if (lowerQuestion.includes('eps') || lowerQuestion.includes('earnings per share') || 
                lowerQuestion.includes('dividend') || lowerQuestion.includes('retained earnings') || 
                lowerQuestion.includes('bvps') || lowerQuestion.includes('book value per share')) {
                
                return handleComprehensiveDebtAnalysis(question, numbers);
            }
            
            if (numbers.length >= 2) {
                const totalDebt = numbers[0];
                const totalAssets = numbers[1];
                const ratio = (totalDebt / totalAssets) * 100;
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Debt Ratio Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Total Debt = ${formatCurrency(totalDebt, currency)}</li>
                            <li>Total Assets = ${formatCurrency(totalAssets, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> Debt Ratio = (Total Debt √∑ Total Assets) √ó 100%
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Debt Ratio = (${formatCurrency(totalDebt, currency)} √∑ ${formatCurrency(totalAssets, currency)}) √ó 100%</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Debt Ratio = ${(totalDebt/totalAssets).toFixed(4)} √ó 100% = ${ratio.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${ratio.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${ratio > 60 ? 'High leverage - risky financial position' : ratio > 40 ? 'Moderate leverage - acceptable risk' : 'Low leverage - conservative financial position'}</p>
                        <p><strong>Meaning:</strong> ${ratio.toFixed(2)}% of the company's assets are financed by debt.</p>
                    </div>
                `;
            }
            return `I can help calculate debt ratio! Please provide total debt and total assets amounts.`;
        }

        function handleComprehensiveDebtAnalysis(question, numbers) {
            if (numbers.length >= 5) {
                const eps = numbers[0];           // ‚Çπ4
                const dividend = numbers[1];      // ‚Çπ2
                const retainedEarnings = numbers[2]; // ‚Çπ12 million
                const bvps = numbers[3];          // ‚Çπ40
                const debt = numbers[4];          // ‚Çπ120 million
                const currency = detectCurrency(question);
                
                // Step 1: Calculate number of shares
                const retentionPerShare = eps - dividend;
                const numberOfShares = retainedEarnings * 1000000 / retentionPerShare; // Convert millions to actual
                
                // Step 2: Calculate total equity
                const totalEquity = numberOfShares * bvps;
                
                // Step 3: Calculate total assets
                const totalAssets = totalEquity + (debt * 1000000); // Convert debt to actual amount
                
                // Step 4: Calculate debt-to-assets ratio
                const debtToAssetsRatio = ((debt * 1000000) / totalAssets) * 100;
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Comprehensive Debt-to-Assets Analysis</h4>
                        <p><strong>Given Information:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Earnings per Share (EPS) = ‚Çπ${eps}</li>
                            <li>Dividend per Share = ‚Çπ${dividend}</li>
                            <li>Increase in Retained Earnings = ‚Çπ${retainedEarnings} million</li>
                            <li>Book Value per Share (BVPS) = ‚Çπ${bvps}</li>
                            <li>Year-end Debt = ‚Çπ${debt} million</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Multi-Step Approach:</strong><br>
                        1. Find Number of Shares: Retained Earnings √∑ Retention per Share<br>
                        2. Calculate Total Equity: Shares √ó BVPS<br>
                        3. Find Total Assets: Equity + Debt<br>
                        4. Calculate Debt/Assets Ratio: (Debt √∑ Assets) √ó 100%
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        
                        <p><strong>Step 1:</strong> Calculate retention per share</p>
                        <p>Retention per Share = EPS - Dividend = ‚Çπ${eps} - ‚Çπ${dividend} = ‚Çπ${retentionPerShare}</p>
                        
                        <p><strong>Step 2:</strong> Find number of outstanding shares</p>
                        <p>Number of Shares = Total Retained Earnings √∑ Retention per Share</p>
                        <p>Number of Shares = ‚Çπ${retainedEarnings} million √∑ ‚Çπ${retentionPerShare} = ${(numberOfShares/1000000).toFixed(2)} million shares</p>
                        
                        <p><strong>Step 3:</strong> Calculate total shareholders' equity</p>
                        <p>Total Equity = Number of Shares √ó BVPS</p>
                        <p>Total Equity = ${(numberOfShares/1000000).toFixed(2)} million √ó ‚Çπ${bvps} = ‚Çπ${(totalEquity/1000000).toFixed(2)} million</p>
                        
                        <p><strong>Step 4:</strong> Calculate total assets</p>
                        <p>Total Assets = Total Equity + Total Debt</p>
                        <p>Total Assets = ‚Çπ${(totalEquity/1000000).toFixed(2)} million + ‚Çπ${debt} million = ‚Çπ${(totalAssets/1000000).toFixed(2)} million</p>
                        
                        <p><strong>Step 5:</strong> Calculate debt-to-assets ratio</p>
                        <p>Debt/Assets Ratio = (Total Debt √∑ Total Assets) √ó 100%</p>
                        <p>Debt/Assets Ratio = (‚Çπ${debt} million √∑ ‚Çπ${(totalAssets/1000000).toFixed(2)} million) √ó 100%</p>
                        <p>Debt/Assets Ratio = ${debtToAssetsRatio.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Final Answer & Analysis:</h4>
                        <p><strong>Year-end Debt-to-Assets Ratio:</strong> ${debtToAssetsRatio.toFixed(2)}%</p>
                        
                        <div class="mt-3 p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                            <h5 class="font-semibold text-green-700 mb-2">üìã Summary of Calculations:</h5>
                            <div class="text-sm space-y-1">
                                <p>‚Ä¢ Outstanding Shares: ${(numberOfShares/1000000).toFixed(2)} million</p>
                                <p>‚Ä¢ Total Shareholders' Equity: ‚Çπ${(totalEquity/1000000).toFixed(2)} million</p>
                                <p>‚Ä¢ Total Assets: ‚Çπ${(totalAssets/1000000).toFixed(2)} million</p>
                                <p>‚Ä¢ Total Debt: ‚Çπ${debt} million</p>
                                <p>‚Ä¢ <strong>Debt-to-Assets Ratio: ${debtToAssetsRatio.toFixed(2)}%</strong></p>
                            </div>
                        </div>
                        
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <h5 class="font-semibold text-blue-700 mb-2">üéØ Financial Interpretation:</h5>
                            <p class="text-sm"><strong>Leverage Analysis:</strong> ${debtToAssetsRatio > 50 ? 'High leverage - significant portion of assets financed by debt' : debtToAssetsRatio > 30 ? 'Moderate leverage - balanced capital structure' : 'Conservative leverage - low financial risk'}</p>
                            <p class="text-sm"><strong>Meaning:</strong> ${debtToAssetsRatio.toFixed(1)}% of the company's assets are financed through debt, while ${(100-debtToAssetsRatio).toFixed(1)}% are financed through equity.</p>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="step-box">
                    <h4 class="font-bold text-orange-600 mb-2">üîç Multi-Step Financial Analysis</h4>
                    <p>I can solve comprehensive problems like this! Please provide all the required data:</p>
                    
                    <div class="mt-3 p-3 bg-orange-50 rounded-lg border-l-4 border-orange-400">
                        <h5 class="font-semibold text-orange-700 mb-2">üìù Required Information:</h5>
                        <ul class="list-disc list-inside text-sm space-y-1">
                            <li><strong>Earnings per Share (EPS)</strong> - in ‚Çπ</li>
                            <li><strong>Dividend per Share</strong> - in ‚Çπ</li>
                            <li><strong>Increase in Retained Earnings</strong> - in millions</li>
                            <li><strong>Book Value per Share (BVPS)</strong> - in ‚Çπ</li>
                            <li><strong>Year-end Debt</strong> - in millions</li>
                        </ul>
                    </div>
                    
                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <h5 class="font-semibold text-blue-700 mb-2">üîÑ Solution Process:</h5>
                        <div class="text-sm space-y-1">
                            <p><strong>Step 1:</strong> Calculate retention per share (EPS - Dividend)</p>
                            <p><strong>Step 2:</strong> Find number of shares (Retained Earnings √∑ Retention per share)</p>
                            <p><strong>Step 3:</strong> Calculate total equity (Shares √ó BVPS)</p>
                            <p><strong>Step 4:</strong> Find total assets (Equity + Debt)</p>
                            <p><strong>Step 5:</strong> Calculate debt-to-assets ratio</p>
                        </div>
                    </div>
                    
                    <p class="mt-3 text-sm bg-gray-100 p-2 rounded">
                        <strong>Example:</strong> "EPS = ‚Çπ4, dividend = ‚Çπ2, retained earnings increase = ‚Çπ12 million, BVPS = ‚Çπ40, debt = ‚Çπ120 million"
                    </p>
                </div>
            `;
        }

        function handleGrossProfit(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const revenue = numbers[0];
                const cogs = numbers[1];
                const grossProfit = revenue - cogs;
                const margin = (grossProfit / revenue) * 100;
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Gross Profit Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Revenue = ${formatCurrency(revenue, currency)}</li>
                            <li>Cost of Goods Sold = ${formatCurrency(cogs, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> Gross Profit = Revenue - Cost of Goods Sold<br>
                        <strong>Gross Margin:</strong> (Gross Profit √∑ Revenue) √ó 100%
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Calculate Gross Profit</p>
                        <p>Gross Profit = ${formatCurrency(revenue, currency)} - ${formatCurrency(cogs, currency)} = ${formatCurrency(grossProfit, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate Gross Margin</p>
                        <p>Gross Margin = (${formatCurrency(grossProfit, currency)} √∑ ${formatCurrency(revenue, currency)}) √ó 100% = ${margin.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                        <p><strong>Gross Profit:</strong> ${formatCurrency(grossProfit, currency)}</p>
                        <p><strong>Gross Margin:</strong> ${margin.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${margin > 50 ? 'Excellent profitability' : margin > 30 ? 'Good profitability' : margin > 15 ? 'Average profitability' : 'Low profitability - review pricing or costs'}</p>
                    </div>
                `;
            }
            return `I can help calculate gross profit! Please provide revenue and cost of goods sold amounts.`;
        }

            // Context-aware analysis for ambiguous questions
            if (lowerQuestion.includes('calculate') || lowerQuestion.includes('find') || lowerQuestion.includes('what is')) {
                return analyzeContextualQuestion(question);
            }
            
            // General help with enhanced intelligence
            return generateGeneralResponse(question);
        }

        function analyzeContextualQuestion(question) {
            const numbers = extractNumbers(question);
            const lowerQuestion = question.toLowerCase();
            
            // Intelligent context analysis
            if (numbers.length >= 2) {
                // Two numbers - likely ratio calculation
                if (lowerQuestion.includes('assets') && lowerQuestion.includes('liabilities')) {
                    return handleCurrentRatio(question);
                }
                if (lowerQuestion.includes('income') && (lowerQuestion.includes('assets') || lowerQuestion.includes('equity'))) {
                    return lowerQuestion.includes('equity') ? handleROE(question) : handleROA(question);
                }
                if (lowerQuestion.includes('rate') || lowerQuestion.includes('%') || lowerQuestion.includes('percent')) {
                    return lowerQuestion.includes('compound') ? handleCompoundInterest(question) : handleSimpleInterest(question);
                }
            }
            
            if (numbers.length >= 3) {
                // Three numbers - likely interest or time value calculation
                if (lowerQuestion.includes('interest') || lowerQuestion.includes('rate')) {
                    return lowerQuestion.includes('compound') ? handleCompoundInterest(question) : handleSimpleInterest(question);
                }
                if (lowerQuestion.includes('present') || lowerQuestion.includes('future')) {
                    return lowerQuestion.includes('present') ? handlePresentValue(question) : handleFutureValue(question);
                }
            }
            
            return `<div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üîç Pattern Analysis Complete</h4>
                        <p><strong>Data Points Identified:</strong> ${numbers.map(n => formatCurrency(n, detectCurrency(question))).join(', ')}</p>
                        
                        <div class="mt-3 p-3 bg-blue-50 rounded-lg">
                            <h5 class="font-semibold text-blue-700 mb-2">Probable Calculation Types:</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                    <span><strong>Ratio Analysis:</strong> If these are balance sheet or income statement items</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                    <span><strong>Interest Calculation:</strong> If you have principal, rate, and time period</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                                    <span><strong>Time Value Analysis:</strong> If these are cash flows with discount rates</span>
                                </div>
                            </div>
                        </div>
                        
                        <p class="mt-3 font-medium text-gray-700">
                            <strong>Next Step:</strong> Tell me which calculation type you need, and I'll process it with full analysis and interpretation.
                        </p>
                    </div>`;
        }

        function extractNumbers(text) {
            // Enhanced number extraction for Indian currency and millions/crores
            const numbers = text.match(/\d+(?:,\d{2,3})*(?:\.\d+)?/g);
            if (!numbers) return [];
            
            return numbers.map(n => {
                let value = parseFloat(n.replace(/,/g, ''));
                
                // Handle Indian currency multipliers
                const lowerText = text.toLowerCase();
                const index = text.toLowerCase().indexOf(n.replace(/,/g, ''));
                const contextAfter = lowerText.substring(index, index + 50);
                
                if (contextAfter.includes('crore') || contextAfter.includes('cr')) {
                    value *= 10000000; // 1 crore = 10 million
                } else if (contextAfter.includes('lakh') || contextAfter.includes('lac')) {
                    value *= 100000; // 1 lakh = 100 thousand
                } else if (contextAfter.includes('million') || contextAfter.includes('m ')) {
                    value *= 1000000;
                } else if (contextAfter.includes('thousand') || contextAfter.includes('k ')) {
                    value *= 1000;
                }
                
                return value;
            });
        }

        function formatCurrency(amount, currency = 'INR') {
            if (currency === 'INR') {
                // Indian number formatting with crores and lakhs
                if (amount >= 10000000) {
                    return `‚Çπ${(amount / 10000000).toFixed(2)} crores`;
                } else if (amount >= 100000) {
                    return `‚Çπ${(amount / 100000).toFixed(2)} lakhs`;
                } else if (amount >= 1000) {
                    return `‚Çπ${(amount / 1000).toFixed(2)}K`;
                } else {
                    return `‚Çπ${amount.toLocaleString('en-IN')}`;
                }
            } else {
                // International formatting
                if (amount >= 1000000) {
                    return `$${(amount / 1000000).toFixed(2)}M`;
                } else if (amount >= 1000) {
                    return `$${(amount / 1000).toFixed(2)}K`;
                } else {
                    return `$${amount.toLocaleString()}`;
                }
            }
        }

        function detectCurrency(text) {
            const lowerText = text.toLowerCase();
            if (lowerText.includes('‚Çπ') || lowerText.includes('rupee') || lowerText.includes('inr') || 
                lowerText.includes('crore') || lowerText.includes('lakh')) {
                return 'INR';
            }
            return 'USD';
        }

        function handleCurrentRatio(question) {
            const numbers = extractNumbers(question);
            const lowerQuestion = question.toLowerCase();
            
            // Check if question is incomplete (missing current liabilities value)
            if (numbers.length === 1 && (lowerQuestion.includes('current liabilities and') || lowerQuestion.includes('liabilities and'))) {
                const assets = numbers[0];
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-orange-600 mb-2">‚ö†Ô∏è Incomplete Data Detected</h4>
                        <p><strong>I found:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Current Assets = ${formatCurrency(assets, currency)} ‚úÖ</li>
                            <li>Current Liabilities = <span class="text-red-600 font-bold">MISSING VALUE</span> ‚ùå</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> Current Ratio = Current Assets √∑ Current Liabilities
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üîß What I Need:</h4>
                        <p><strong>Please provide the Current Liabilities amount to complete the calculation.</strong></p>
                        <p class="mt-2">For example, say:</p>
                        <div class="bg-blue-50 p-3 rounded-lg mt-2">
                            <p class="font-medium">"Current assets = ${formatCurrency(assets, currency)}, current liabilities = [AMOUNT], what is the current ratio?"</p>
                        </div>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Quick Examples:</h4>
                        <div class="space-y-2">
                            <div class="bg-green-50 p-2 rounded border-l-4 border-green-400">
                                <p class="text-sm"><strong>If liabilities = ${formatCurrency(assets/2, currency)}:</strong> Ratio = ${(assets/(assets/2)).toFixed(2)} (Good liquidity)</p>
                            </div>
                            <div class="bg-yellow-50 p-2 rounded border-l-4 border-yellow-400">
                                <p class="text-sm"><strong>If liabilities = ${formatCurrency(assets, currency)}:</strong> Ratio = 1.00 (Break-even liquidity)</p>
                            </div>
                            <div class="bg-red-50 p-2 rounded border-l-4 border-red-400">
                                <p class="text-sm"><strong>If liabilities = ${formatCurrency(assets*1.5, currency)}:</strong> Ratio = 0.67 (Poor liquidity)</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (numbers.length >= 2) {
                const assets = numbers[0];
                const liabilities = numbers[1];
                const ratio = assets / liabilities;
                const interpretation = financialKnowledge.liquidity.current.interpretation(ratio);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Current Ratio Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Current Assets = ${formatCurrency(assets, currency)}</li>
                            <li>Current Liabilities = ${formatCurrency(liabilities, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.liquidity.current.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>Current Ratio = ${formatCurrency(assets, currency)} √∑ ${formatCurrency(liabilities, currency)}</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>Current Ratio = ${assets.toLocaleString()} √∑ ${liabilities.toLocaleString()} = ${ratio.toFixed(2)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${ratio.toFixed(2)}</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> For every ${currency === 'INR' ? '‚Çπ1' : '$1'} of current liabilities, the company has ${currency === 'INR' ? '‚Çπ' : '$'}${ratio.toFixed(2)} in current assets.</p>
                        ${ratio === 1 ? '<p><strong>Special Note:</strong> A ratio of 1.0 means current assets exactly equal current liabilities - the company can just cover its short-term obligations.</p>' : ''}
                    </div>
                `;
            }
            
            return `
                <div class="step-box">
                    <h4 class="font-bold text-blue-600 mb-2">üéØ Current Ratio Calculator Ready</h4>
                    <p>I can help you calculate the current ratio! Please provide:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong>Current Assets amount</strong> (cash, inventory, receivables, etc.)</li>
                        <li><strong>Current Liabilities amount</strong> (accounts payable, short-term debt, etc.)</li>
                    </ul>
                    
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <h5 class="font-semibold text-blue-700 mb-2">üìù Example Formats:</h5>
                        <div class="text-sm space-y-1">
                            <p>‚Ä¢ "Current assets = $50,000, current liabilities = $25,000, find current ratio"</p>
                            <p>‚Ä¢ "Calculate current ratio with assets ‚Çπ2.5 crores and liabilities ‚Çπ1.2 crores"</p>
                            <p>‚Ä¢ "Given current assets 100000 and current liabilities 75000, what is current ratio?"</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleQuickRatio(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 3) {
                const assets = numbers[0];
                const inventory = numbers[1];
                const liabilities = numbers[2];
                const ratio = (assets - inventory) / liabilities;
                const interpretation = financialKnowledge.liquidity.quick.interpretation(ratio);
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Quick Ratio (Acid Test) Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Current Assets = ${formatCurrency(assets, currency)}</li>
                            <li>Inventory = ${formatCurrency(inventory, currency)}</li>
                            <li>Current Liabilities = ${formatCurrency(liabilities, currency)}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.liquidity.quick.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Calculate liquid assets</p>
                        <p>Liquid Assets = ${formatCurrency(assets, currency)} - ${formatCurrency(inventory, currency)} = ${formatCurrency(assets - inventory, currency)}</p>
                        <p><strong>Step 2:</strong> Apply the formula</p>
                        <p>Quick Ratio = ${formatCurrency(assets - inventory, currency)} √∑ ${formatCurrency(liabilities, currency)}</p>
                        <p><strong>Step 3:</strong> Calculate</p>
                        <p>Quick Ratio = ${ratio.toFixed(2)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${ratio.toFixed(2)}</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Why exclude inventory?</strong> Inventory may be difficult to convert to cash quickly.</p>
                    </div>
                `;
            }
            
            return `I can help you calculate the quick ratio! Please provide:
                    <ul class="list-disc list-inside mt-2">
                        <li>Current Assets amount</li>
                        <li>Inventory amount</li>
                        <li>Current Liabilities amount</li>
                    </ul>`;
        }

        function handleROA(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const netIncome = numbers[0];
                const totalAssets = numbers[1];
                const roa = (netIncome / totalAssets) * 100;
                const interpretation = financialKnowledge.ratios.roa.interpretation(roa);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Return on Assets (ROA) Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Net Income = $${netIncome.toLocaleString()}</li>
                            <li>Total Assets = $${totalAssets.toLocaleString()}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.ratios.roa.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>ROA = ($${netIncome.toLocaleString()} √∑ $${totalAssets.toLocaleString()}) √ó 100%</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>ROA = ${(netIncome/totalAssets).toFixed(4)} √ó 100% = ${roa.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${roa.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> The company generates $${roa.toFixed(2)} of profit for every $100 of assets.</p>
                    </div>
                `;
            }
            
            return `I can help you calculate ROA! Please provide:
                    <ul class="list-disc list-inside mt-2">
                        <li>Net Income amount</li>
                        <li>Total Assets amount</li>
                    </ul>`;
        }

        function handleROE(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 2) {
                const netIncome = numbers[0];
                const equity = numbers[1];
                const roe = (netIncome / equity) * 100;
                const interpretation = financialKnowledge.ratios.roe.interpretation(roe);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Return on Equity (ROE) Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Net Income = $${netIncome.toLocaleString()}</li>
                            <li>Shareholders' Equity = $${equity.toLocaleString()}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> ${financialKnowledge.ratios.roe.formula}
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Apply the formula</p>
                        <p>ROE = ($${netIncome.toLocaleString()} √∑ $${equity.toLocaleString()}) √ó 100%</p>
                        <p><strong>Step 2:</strong> Calculate</p>
                        <p>ROE = ${(netIncome/equity).toFixed(4)} √ó 100% = ${roe.toFixed(2)}%</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Interpretation:</h4>
                        <p><strong>Result:</strong> ${roe.toFixed(2)}%</p>
                        <p><strong>Analysis:</strong> ${interpretation}</p>
                        <p><strong>Meaning:</strong> Shareholders earn ${roe.toFixed(2)}% return on their investment.</p>
                    </div>
                `;
            }
            
            return `I can help you calculate ROE! Please provide:
                    <ul class="list-disc list-inside mt-2">
                        <li>Net Income amount</li>
                        <li>Shareholders' Equity amount</li>
                    </ul>`;
        }

        function handleSimpleInterest(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 3) {
                const principal = numbers[0];
                const rate = numbers[1];
                const time = numbers[2];
                const interest = principal * (rate / 100) * time;
                const total = principal + interest;
                const currency = detectCurrency(question);
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Simple Interest Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Principal (P) = ${formatCurrency(principal, currency)}</li>
                            <li>Rate (r) = ${rate}% per year</li>
                            <li>Time (t) = ${time} years</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> I = P √ó r √ó t
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Convert rate to decimal</p>
                        <p>r = ${rate}% = ${rate/100}</p>
                        <p><strong>Step 2:</strong> Apply the formula</p>
                        <p>I = ${formatCurrency(principal, currency)} √ó ${rate/100} √ó ${time}</p>
                        <p><strong>Step 3:</strong> Calculate interest</p>
                        <p>I = ${formatCurrency(interest, currency)}</p>
                        <p><strong>Step 4:</strong> Calculate total amount</p>
                        <p>Total = Principal + Interest = ${formatCurrency(principal, currency)} + ${formatCurrency(interest, currency)} = ${formatCurrency(total, currency)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                        <p><strong>Interest Earned:</strong> ${formatCurrency(interest, currency)}</p>
                        <p><strong>Total Amount:</strong> ${formatCurrency(total, currency)}</p>
                        <p><strong>Note:</strong> Simple interest grows linearly over time.</p>
                    </div>
                `;
            }
            
            return `I can help you calculate simple interest! Please provide:
                    <ul class="list-disc list-inside mt-2">
                        <li>Principal amount</li>
                        <li>Interest rate (% per year)</li>
                        <li>Time period (years)</li>
                    </ul>`;
        }

        function handleCompoundInterest(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 3) {
                const principal = numbers[0];
                const rate = numbers[1];
                const time = numbers[2];
                const currency = detectCurrency(question);
                
                // Determine compounding frequency
                let compounds = 1; // Default to annually
                if (question.includes('quarterly')) compounds = 4;
                else if (question.includes('monthly')) compounds = 12;
                else if (question.includes('daily')) compounds = 365;
                else if (question.includes('semi')) compounds = 2;
                
                const amount = principal * Math.pow(1 + (rate / 100) / compounds, compounds * time);
                const interest = amount - principal;
                
                const compoundText = compounds === 1 ? 'annually' : 
                                  compounds === 2 ? 'semi-annually' : 
                                  compounds === 4 ? 'quarterly' : 
                                  compounds === 12 ? 'monthly' : 'daily';
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Compound Interest Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Principal (P) = ${formatCurrency(principal, currency)}</li>
                            <li>Rate (r) = ${rate}% per year</li>
                            <li>Time (t) = ${time} years</li>
                            <li>Compounding = ${compoundText} (n = ${compounds})</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> A = P(1 + r/n)^(nt)
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Identify values</p>
                        <p>P = ${formatCurrency(principal, currency)}, r = ${rate/100}, n = ${compounds}, t = ${time}</p>
                        <p><strong>Step 2:</strong> Apply the formula</p>
                        <p>A = ${formatCurrency(principal, currency)}(1 + ${rate/100}/${compounds})^(${compounds} √ó ${time})</p>
                        <p><strong>Step 3:</strong> Simplify inside parentheses</p>
                        <p>A = ${formatCurrency(principal, currency)}(1 + ${((rate/100)/compounds).toFixed(6)})^${compounds * time}</p>
                        <p>A = ${formatCurrency(principal, currency)}(${(1 + (rate/100)/compounds).toFixed(6)})^${compounds * time}</p>
                        <p><strong>Step 4:</strong> Calculate final amount</p>
                        <p>A = ${formatCurrency(amount, currency)}</p>
                        <p><strong>Step 5:</strong> Calculate compound interest</p>
                        <p>I = A - P = ${formatCurrency(amount, currency)} - ${formatCurrency(principal, currency)} = ${formatCurrency(interest, currency)}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                        <p><strong>Compound Interest:</strong> ${formatCurrency(interest, currency)}</p>
                        <p><strong>Final Amount:</strong> ${formatCurrency(amount, currency)}</p>
                        <p><strong>Note:</strong> Compound interest grows exponentially due to earning interest on interest!</p>
                    </div>
                `;
            }
            
            return `I can help you calculate compound interest! Please provide:
                    <ul class="list-disc list-inside mt-2">
                        <li>Principal amount</li>
                        <li>Interest rate (% per year)</li>
                        <li>Time period (years)</li>
                        <li>Compounding frequency (annually, quarterly, monthly, etc.)</li>
                    </ul>`;
        }

        function handlePresentValue(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 3) {
                const futureValue = numbers[0];
                const rate = numbers[1];
                const periods = numbers[2];
                const presentValue = futureValue / Math.pow(1 + (rate / 100), periods);
                const discount = futureValue - presentValue;
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Present Value Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Future Value (FV) = $${futureValue.toLocaleString()}</li>
                            <li>Discount Rate (r) = ${rate}%</li>
                            <li>Number of Periods (n) = ${periods}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> PV = FV √∑ (1 + r)^n
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Convert rate to decimal</p>
                        <p>r = ${rate}% = ${rate/100}</p>
                        <p><strong>Step 2:</strong> Apply the formula</p>
                        <p>PV = $${futureValue.toLocaleString()} √∑ (1 + ${rate/100})^${periods}</p>
                        <p><strong>Step 3:</strong> Calculate denominator</p>
                        <p>(1 + ${rate/100})^${periods} = ${Math.pow(1 + (rate/100), periods).toFixed(4)}</p>
                        <p><strong>Step 4:</strong> Calculate present value</p>
                        <p>PV = $${futureValue.toLocaleString()} √∑ ${Math.pow(1 + (rate/100), periods).toFixed(4)} = $${presentValue.toLocaleString()}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                        <p><strong>Present Value:</strong> $${presentValue.toLocaleString()}</p>
                        <p><strong>Discount Amount:</strong> $${discount.toLocaleString()}</p>
                        <p><strong>Meaning:</strong> $${presentValue.toLocaleString()} today is equivalent to $${futureValue.toLocaleString()} in ${periods} periods at ${rate}% discount rate.</p>
                    </div>
                `;
            }
            
            return `I can help you calculate present value! Please provide:
                    <ul class="list-disc list-inside mt-2">
                        <li>Future Value amount</li>
                        <li>Discount rate (%)</li>
                        <li>Number of periods</li>
                    </ul>`;
        }

        function handleFutureValue(question) {
            const numbers = extractNumbers(question);
            if (numbers.length >= 3) {
                const presentValue = numbers[0];
                const rate = numbers[1];
                const periods = numbers[2];
                const futureValue = presentValue * Math.pow(1 + (rate / 100), periods);
                const growth = futureValue - presentValue;
                
                return `
                    <div class="step-box">
                        <h4 class="font-bold text-purple-600 mb-2">üßÆ Future Value Calculation</h4>
                        <p><strong>Given:</strong></p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Present Value (PV) = $${presentValue.toLocaleString()}</li>
                            <li>Growth Rate (r) = ${rate}%</li>
                            <li>Number of Periods (n) = ${periods}</li>
                        </ul>
                    </div>
                    
                    <div class="formula-box">
                        <strong>Formula:</strong> FV = PV √ó (1 + r)^n
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                        <p><strong>Step 1:</strong> Convert rate to decimal</p>
                        <p>r = ${rate}% = ${rate/100}</p>
                        <p><strong>Step 2:</strong> Apply the formula</p>
                        <p>FV = $${presentValue.toLocaleString()} √ó (1 + ${rate/100})^${periods}</p>
                        <p><strong>Step 3:</strong> Calculate growth factor</p>
                        <p>(1 + ${rate/100})^${periods} = ${Math.pow(1 + (rate/100), periods).toFixed(4)}</p>
                        <p><strong>Step 4:</strong> Calculate future value</p>
                        <p>FV = $${presentValue.toLocaleString()} √ó ${Math.pow(1 + (rate/100), periods).toFixed(4)} = $${futureValue.toLocaleString()}</p>
                    </div>
                    
                    <div class="step-box">
                        <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                        <p><strong>Future Value:</strong> $${futureValue.toLocaleString()}</p>
                        <p><strong>Growth Amount:</strong> $${growth.toLocaleString()}</p>
                        <p><strong>Meaning:</strong> $${presentValue.toLocaleString()} today will grow to $${futureValue.toLocaleString()} in ${periods} periods at ${rate}% growth rate.</p>
                    </div>
                `;
            }
            
            return `I can help you calculate future value! Please provide:
                    <ul class="list-disc list-inside mt-2">
                        <li>Present Value amount</li>
                        <li>Growth rate (%)</li>
                        <li>Number of periods</li>
                    </ul>`;
        }

        function handleAnnuity(question) {
            const numbers = extractNumbers(question);
            const lowerQuestion = question.toLowerCase();
            
            if (numbers.length >= 3) {
                const payment = numbers[0];
                const rate = numbers[1];
                const periods = numbers[2];
                const r = rate / 100;
                
                if (lowerQuestion.includes('present value')) {
                    const presentValue = payment * ((1 - Math.pow(1 + r, -periods)) / r);
                    const totalPayments = payment * periods;
                    
                    return `
                        <div class="step-box">
                            <h4 class="font-bold text-purple-600 mb-2">üßÆ Present Value of Annuity</h4>
                            <p><strong>Given:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                                <li>Payment (PMT) = $${payment.toLocaleString()}</li>
                                <li>Interest Rate (r) = ${rate}%</li>
                                <li>Number of Periods (n) = ${periods}</li>
                            </ul>
                        </div>
                        
                        <div class="formula-box">
                            <strong>Formula:</strong> PVA = PMT √ó [(1 - (1 + r)^-n) √∑ r]
                        </div>
                        
                        <div class="step-box">
                            <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                            <p><strong>Step 1:</strong> Convert rate to decimal</p>
                            <p>r = ${rate}% = ${r}</p>
                            <p><strong>Step 2:</strong> Calculate (1 + r)^-n</p>
                            <p>(1 + ${r})^-${periods} = ${Math.pow(1 + r, -periods).toFixed(6)}</p>
                            <p><strong>Step 3:</strong> Calculate the bracket</p>
                            <p>[1 - ${Math.pow(1 + r, -periods).toFixed(6)}] √∑ ${r} = ${((1 - Math.pow(1 + r, -periods)) / r).toFixed(4)}</p>
                            <p><strong>Step 4:</strong> Calculate PVA</p>
                            <p>PVA = $${payment.toLocaleString()} √ó ${((1 - Math.pow(1 + r, -periods)) / r).toFixed(4)} = $${presentValue.toLocaleString()}</p>
                        </div>
                        
                        <div class="step-box">
                            <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                            <p><strong>Present Value of Annuity:</strong> $${presentValue.toLocaleString()}</p>
                            <p><strong>Total Payments:</strong> $${totalPayments.toLocaleString()}</p>
                            <p><strong>Meaning:</strong> The current value of ${periods} payments of $${payment.toLocaleString()} each is $${presentValue.toLocaleString()}.</p>
                        </div>
                    `;
                } else {
                    const futureValue = payment * ((Math.pow(1 + r, periods) - 1) / r);
                    const totalPayments = payment * periods;
                    const growth = futureValue - totalPayments;
                    
                    return `
                        <div class="step-box">
                            <h4 class="font-bold text-purple-600 mb-2">üßÆ Future Value of Annuity</h4>
                            <p><strong>Given:</strong></p>
                            <ul class="list-disc list-inside ml-4">
                                <li>Payment (PMT) = $${payment.toLocaleString()}</li>
                                <li>Interest Rate (r) = ${rate}%</li>
                                <li>Number of Periods (n) = ${periods}</li>
                            </ul>
                        </div>
                        
                        <div class="formula-box">
                            <strong>Formula:</strong> FVA = PMT √ó [((1 + r)^n - 1) √∑ r]
                        </div>
                        
                        <div class="step-box">
                            <h4 class="font-bold text-blue-600 mb-2">üìä Step-by-Step Solution:</h4>
                            <p><strong>Step 1:</strong> Convert rate to decimal</p>
                            <p>r = ${rate}% = ${r}</p>
                            <p><strong>Step 2:</strong> Calculate (1 + r)^n</p>
                            <p>(1 + ${r})^${periods} = ${Math.pow(1 + r, periods).toFixed(4)}</p>
                            <p><strong>Step 3:</strong> Calculate the bracket</p>
                            <p>[${Math.pow(1 + r, periods).toFixed(4)} - 1] √∑ ${r} = ${((Math.pow(1 + r, periods) - 1) / r).toFixed(4)}</p>
                            <p><strong>Step 4:</strong> Calculate FVA</p>
                            <p>FVA = $${payment.toLocaleString()} √ó ${((Math.pow(1 + r, periods) - 1) / r).toFixed(4)} = $${futureValue.toLocaleString()}</p>
                        </div>
                        
                        <div class="step-box">
                            <h4 class="font-bold text-green-600 mb-2">üí° Final Answer:</h4>
                            <p><strong>Future Value of Annuity:</strong> $${futureValue.toLocaleString()}</p>
                            <p><strong>Total Payments:</strong> $${totalPayments.toLocaleString()}</p>
                            <p><strong>Interest Earned:</strong> $${growth.toLocaleString()}</p>
                            <p><strong>Meaning:</strong> ${periods} payments of $${payment.toLocaleString()} each will grow to $${futureValue.toLocaleString()}.</p>
                        </div>
                    `;
                }
            }
            
            return `I can help you calculate annuity values! Please specify:
                    <ul class="list-disc list-inside mt-2">
                        <li>Payment amount per period</li>
                        <li>Interest rate per period (%)</li>
                        <li>Number of periods</li>
                        <li>Whether you want present value or future value</li>
                    </ul>`;
        }

        function generateGeneralResponse(question) {
            const responses = [
                `<div class="step-box">
                    <h4 class="font-bold text-blue-600 mb-2">üéØ Analysis Request Received</h4>
                    <p>I need a bit more data to run the calculation. Here's what would help:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong>Calculation Type:</strong> Ratio analysis, interest calculation, or valuation?</li>
                        <li><strong>Given Values:</strong> What numbers do you have?</li>
                        <li><strong>Target Output:</strong> What specific result do you need?</li>
                    </ul>
                    <p class="mt-2 text-sm bg-blue-50 p-2 rounded">
                        <strong>Pro Tip:</strong> The more specific your question, the more precise my analysis will be.
                    </p>
                </div>`,
                
                `<div class="step-box">
                    <h4 class="font-bold text-purple-600 mb-2">üß† Financial Intelligence Ready</h4>
                    <p>I can process these calculation categories with full analysis:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 text-sm">
                        <div class="bg-gray-50 p-2 rounded">
                            <strong>Liquidity & Efficiency:</strong><br>
                            Current, Quick, Turnover Ratios
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <strong>Profitability & Returns:</strong><br>
                            ROA, ROE, Margin Analysis
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <strong>Time Value Calculations:</strong><br>
                            PV, FV, Interest Computations
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <strong>Market & Leverage:</strong><br>
                            P/E, Debt Ratios, Coverage Analysis
                        </div>
                    </div>
                    <p class="mt-2 font-medium">Share your problem details and I'll deliver a complete solution with reasoning.</p>
                </div>`,
                
                `<div class="step-box">
                    <h4 class="font-bold text-green-600 mb-2">‚ö° Ready for Analysis</h4>
                    <p>To deliver the most accurate solution, I need these inputs:</p>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs font-bold">1</span>
                            <span><strong>Financial Concept:</strong> Which formula or ratio do you need?</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs font-bold">2</span>
                            <span><strong>Data Points:</strong> All numerical values with units</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs font-bold">3</span>
                            <span><strong>Expected Output:</strong> What result are you looking for?</span>
                        </div>
                    </div>
                    <p class="mt-2 text-sm bg-green-50 p-2 rounded border-l-4 border-green-400">
                        <strong>Result:</strong> You'll get step-by-step calculations + professional interpretation + industry context.
                    </p>
                </div>`
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Chat Functions
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function askQuestion(question) {
            document.getElementById('user-input').value = question;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Clear input
            input.value = '';
            
            // Add user message
            addMessage(question, 'user');
            
            // Show typing indicator
            showTypingIndicator();
            
            // Generate AI response
            setTimeout(async () => {
                hideTypingIndicator();
                const response = generateAIResponse(question);
                addMessage(response, 'ai');
                
                // Increment problem counter
                totalProblemsCount++;
                
                // Save to history
                await saveToHistory(question, response);
            }, 1500 + Math.random() * 1000); // Simulate thinking time
        }

        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'message user-message';
                messageDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-2 justify-end">
                        <span class="font-semibold">You</span>
                        <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold">üë§</span>
                        </div>
                    </div>
                    <p>${content}</p>
                `;
            } else {
                const aiName = document.getElementById('ai-name').textContent;
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold">ü§ñ</span>
                        </div>
                        <span class="font-semibold text-purple-600">${aiName}</span>
                    </div>
                    <div>${content}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'message typing-indicator';
            
            const aiName = document.getElementById('ai-name').textContent;
            typingDiv.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm font-bold">ü§ñ</span>
                    </div>
                    <span class="font-semibold text-purple-600">${aiName}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span>Thinking</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // History Functions
        async function saveToHistory(question, answer) {
            if (currentData.length >= 999) {
                showMessage("Maximum limit of 999 conversations reached. Please clear some history first.", "error");
                return;
            }

            if (!window.dataSdk) return;

            const problemType = detectProblemType(question);
            const conversation = {
                question: question,
                answer: answer.replace(/<[^>]*>/g, ''), // Strip HTML for storage
                problem_type: problemType,
                timestamp: new Date().toISOString()
            };

            const createResult = await window.dataSdk.create(conversation);
            if (!createResult.isOk) {
                showMessage("Failed to save conversation to history", "error");
            }
        }

        function detectProblemType(question) {
            const lowerQuestion = question.toLowerCase();
            if (lowerQuestion.includes('current ratio')) return 'Current Ratio';
            if (lowerQuestion.includes('quick ratio')) return 'Quick Ratio';
            if (lowerQuestion.includes('roa') || lowerQuestion.includes('return on assets')) return 'ROA';
            if (lowerQuestion.includes('roe') || lowerQuestion.includes('return on equity')) return 'ROE';
            if (lowerQuestion.includes('simple interest')) return 'Simple Interest';
            if (lowerQuestion.includes('compound interest')) return 'Compound Interest';
            if (lowerQuestion.includes('present value')) return 'Present Value';
            if (lowerQuestion.includes('future value')) return 'Future Value';
            if (lowerQuestion.includes('annuity')) return 'Annuity';
            return 'General Question';
        }

        function renderHistory() {
            const historyList = document.getElementById('history-list');
            if (!historyList) return;

            if (currentData.length === 0) {
                historyList.innerHTML = '<p class="text-gray-300 text-sm text-center py-4">No conversations yet</p>';
                return;
            }

            const sortedData = [...currentData].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            historyList.innerHTML = sortedData.slice(0, 10).map(item => {
                const date = new Date(item.timestamp).toLocaleDateString();
                const shortQuestion = item.question.length > 50 ? item.question.substring(0, 50) + '...' : item.question;
                
                return `
                    <div class="history-item" onclick="reloadConversation('${item.question.replace(/'/g, "\\'")}')">
                        <div class="text-white font-semibold text-sm">${item.problem_type}</div>
                        <div class="text-gray-300 text-xs mt-1">${shortQuestion}</div>
                        <div class="text-gray-400 text-xs mt-1">${date}</div>
                    </div>
                `;
            }).join('');
        }

        function reloadConversation(question) {
            document.getElementById('user-input').value = question;
        }

        async function clearHistory() {
            if (!window.dataSdk || currentData.length === 0) return;

            for (const item of currentData) {
                await window.dataSdk.delete(item);
            }
            
            // Clear chat messages
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="ai-message message">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold">ü§ñ</span>
                        </div>
                        <span class="font-semibold text-purple-600">FinanceBot</span>
                    </div>
                    <p>History cleared! I'm ready to help you with new financial problems.</p>
                </div>
            `;
        }

        function showMessage(message, type = "info") {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // Settings Functions
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            const overlay = document.getElementById('settings-overlay');
            
            panel.classList.toggle('open');
            overlay.classList.toggle('open');
            
            // Update statistics when opening settings
            if (panel.classList.contains('open')) {
                updateStatistics();
            }
        }

        function closeSettings() {
            const panel = document.getElementById('settings-panel');
            const overlay = document.getElementById('settings-overlay');
            
            panel.classList.remove('open');
            overlay.classList.remove('open');
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            const toggle = document.getElementById('dark-mode-toggle');
            const body = document.body;
            
            if (isDarkMode) {
                body.classList.add('dark-mode');
                toggle.classList.add('active');
            } else {
                body.classList.remove('dark-mode');
                toggle.classList.remove('active');
            }
            
            // Save preference
            localStorage.setItem('darkMode', isDarkMode);
        }

        function toggleAnimations() {
            animationsEnabled = !animationsEnabled;
            const toggle = document.getElementById('animations-toggle');
            
            if (animationsEnabled) {
                toggle.classList.add('active');
                document.body.style.setProperty('--animation-duration', '0.3s');
            } else {
                toggle.classList.remove('active');
                document.body.style.setProperty('--animation-duration', '0s');
            }
            
            localStorage.setItem('animationsEnabled', animationsEnabled);
        }

        function updateStatistics() {
            const totalConversations = document.getElementById('total-conversations');
            const problemsSolved = document.getElementById('problems-solved');
            
            if (totalConversations) {
                totalConversations.textContent = currentData.length;
            }
            if (problemsSolved) {
                problemsSolved.textContent = totalProblemsCount;
            }
        }

        function exportHistory() {
            if (currentData.length === 0) {
                showMessage("No chat history to export", "error");
                return;
            }

            const exportData = {
                exportDate: new Date().toISOString(),
                totalConversations: currentData.length,
                conversations: currentData.map(item => ({
                    question: item.question,
                    answer: item.answer,
                    problemType: item.problem_type,
                    timestamp: item.timestamp
                }))
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financebot-history-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage("Chat history exported successfully!", "success");
        }

        async function clearAllData() {
            if (currentData.length === 0) {
                showMessage("No data to clear", "error");
                return;
            }

            // Create confirmation UI instead of using confirm()
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Clear All Data?</h3>
                    <p class="text-gray-600 mb-6">This will permanently delete all your chat history. This action cannot be undone.</p>
                    <div class="flex gap-3">
                        <button onclick="confirmClearData()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
                            Clear All
                        </button>
                        <button onclick="cancelClearData()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDiv);
            window.currentConfirmDiv = confirmDiv;
        }

        async function confirmClearData() {
            if (window.currentConfirmDiv) {
                document.body.removeChild(window.currentConfirmDiv);
                window.currentConfirmDiv = null;
            }

            for (const item of currentData) {
                await window.dataSdk.delete(item);
            }

            // Clear chat messages
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="ai-message message">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-bold">ü§ñ</span>
                        </div>
                        <span class="font-semibold text-purple-600">FinanceBot</span>
                    </div>
                    <p>All data cleared! I'm ready to help you with new financial problems.</p>
                </div>
            `;

            totalProblemsCount = 0;
            showMessage("All data cleared successfully!", "success");
            closeSettings();
        }

        function cancelClearData() {
            if (window.currentConfirmDiv) {
                document.body.removeChild(window.currentConfirmDiv);
                window.currentConfirmDiv = null;
            }
        }

        function loadUserPreferences() {
            // Load dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').classList.add('active');
            }

            // Load animations preference
            const savedAnimations = localStorage.getItem('animationsEnabled');
            if (savedAnimations === 'false') {
                animationsEnabled = false;
                document.getElementById('animations-toggle').classList.remove('active');
                document.body.style.setProperty('--animation-duration', '0s');
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            loadUserPreferences();
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9984fbe9857b24a0',t:'MTc2MjEwMDY4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>